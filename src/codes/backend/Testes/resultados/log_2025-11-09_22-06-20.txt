
--- üöÄ Iniciando Setup Global de Testes ---
Garantindo a exist√™ncia das empresas de teste fixas...

--- üöÄ Iniciando cria√ß√£o de empresas de teste fixas ---

--- ‚úÖ Processo conclu√≠do! Dados salvos em: Testes\Docs\dados-empresas-teste.md ---

--- ‚úÖ Setup Global Conclu√≠do ---
  console.log
    Executando teste para: RF-008 - Exportar PDF (Pendente)

      at Object.log (reports.test.js:24:13)

  console.log
    
    --- Criando transa√ß√£o para Empresa A ---

      at Object.log (isolamento.test.js:27:17)

  console.log
    
    --- Tentando listar transa√ß√µes com token da Empresa B ---

      at Object.log (isolamento.test.js:104:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:105:17)

  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:12:17)

  console.log
    ‚úÖ Empresa 1 (Empresa Teste 1762736802808) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    ‚úÖ Empresa 2 (Empresa Teste 1762736803160) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    ‚úÖ Empresa 3 (Empresa Teste 1762736803471) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    --- Configura√ß√£o multi-tenant conclu√≠da ---

      at Object.log (multi-tenant.test.js:43:17)

  console.log
    
    --- Criando transa√ß√µes individuais para cada empresa ---

      at Object.log (multi-tenant.test.js:48:17)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762736802808. ID: 69113aa3f751de39200b5365

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762736803160. ID: 69113aa3f751de39200b536c

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762736803471. ID: 69113aa3f751de39200b5373

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.log (multi-tenant.test.js:75:17)

  console.log
    
    Verificando a transa√ß√£o 69113aa3f751de39200b5365 da Empresa Teste 1762736802808

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762736803160 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762736803471 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    Verificando a transa√ß√£o 69113aa3f751de39200b536c da Empresa Teste 1762736803160

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762736802808 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762736803471 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    Verificando a transa√ß√£o 69113aa3f751de39200b5373 da Empresa Teste 1762736803471

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762736802808 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762736803160 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    --- Validando listagem de transa√ß√µes ---

      at Object.log (multi-tenant.test.js:107:17)

  console.log
    - OK: Empresa Teste 1762736802808 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    - OK: Empresa Teste 1762736803160 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    - OK: Empresa Teste 1762736803471 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:125:17)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762736802808 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762736803160 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762736803471 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (auth.legacy.test.js:27:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (auth.legacy.test.js:30:17)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (auth.legacy.test.js:73:17)

  console.log
    ‚úÖ Login realizado com sucesso.

      at Object.log (auth.legacy.test.js:82:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (auth.legacy.test.js:86:17)

  console.log
    ‚úÖ Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (auth.legacy.test.js:96:21)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (api.test.js:25:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (api.test.js:28:17)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (api.test.js:40:17)

  console.log
    ‚úÖ E-mail duplicado barrado com sucesso (Status 409).

      at Object.log (api.test.js:51:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (api.test.js:60:17)

  console.log
    ‚úÖ Login com senha incorreta falhou como esperado (Status 401).

      at Object.log (api.test.js:69:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (api.test.js:78:17)

  console.log
    ‚úÖ Login realizado com sucesso.

      at Object.log (api.test.js:87:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (api.test.js:91:17)

  console.log
    ‚úÖ Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (api.test.js:101:21)

  console.log
    Executando teste para: RF-009 - CRIAR Cliente (Pendente)

      at Object.log (clients.test.js:23:13)

  console.log
    ‚û°Ô∏è  [PASS] Resposta da API: 201, Cliente criado com ID: 69113aa6f751de39200b53eb

      at Object.log (clients.test.js:39:13)

  console.log
    Executando teste para: RF-009 - LISTAR Clientes (Pendente)

      at Object.log (clients.test.js:43:13)

  console.log
    ‚û°Ô∏è  [PASS] Resposta da API: 200, 4 cliente(s) listado(s).

      at Object.log (clients.test.js:52:13)


--- üßπ Executando Teardown Global ---
--- ‚úÖ Teardown Conclu√≠do ---

--- FIM DOS TESTES AUTOMATIZADOS (COM FALHAS) ---
‚ö†Ô∏è  Aviso: Empresa com e-mail "empresa-frontend@test.com" j√° existe. Pulando cria√ß√£o.
‚ö†Ô∏è  Aviso: Empresa com e-mail "empresa-backend@test.com" j√° existe. Pulando cria√ß√£o.
‚ö†Ô∏è  Aviso: Empresa com e-mail "empresa-react@test.com" j√° existe. Pulando cria√ß√£o.
(node:27436) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 FAIL  Testes/auth.test.js (20.513 s)
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    √ó deve criar um SessionToken no banco de dados ap√≥s o login (10015 ms)
    √ó deve invalidar o SessionToken no banco de dados ap√≥s o logout (10005 ms)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve criar um SessionToken no banco de dados ap√≥s o login

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (../node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:185:23)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve invalidar o SessionToken no banco de dados ap√≥s o logout

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (../node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:185:23)

 FAIL  Testes/reports.test.js
  8. M√≥dulo de Relat√≥rios (TDD)
    √ó deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF (35 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios (TDD) ‚Ä∫ deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF

    AxiosError: Request failed with status code 404

      24 |     console.log('Executando teste para: RF-008 - Exportar PDF (Pendente)');
      25 |
    > 26 |     const response = await axios.get(`${API_URL}/reports/export/pdf`, {
         |                      ^
      27 |       headers: { Authorization: `Bearer ${testToken}` },
      28 |       responseType: 'arraybuffer', // Importante para receber arquivos bin√°rios
      29 |     });

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (reports.test.js:26:22)

 FAIL  Testes/isolamento.legacy.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (13 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (3 ms)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AxiosError: Request failed with status code 401

      34 |     it('deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas', async () => {
      35 |         // --- 1. Criar uma transa√ß√£o com tokenEmpresaA ---
    > 36 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      37 |             description: 'Transa√ß√£o de Teste Empresa A',
      38 |             amount: 100,
      39 |             type: 'expense',

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.legacy.test.js:36:35)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AxiosError: Request failed with status code 401

      92 |      */
      93 |     it('deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A', async () => {
    > 94 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
         |                           ^
      95 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      96 |         });
      97 |

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.legacy.test.js:94:27)

 FAIL  Testes/isolamento-simples.test.js
  2. Teste de Isolamento de Dados (Simples)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (24 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (6 ms)

  ‚óè 2. Teste de Isolamento de Dados (Simples) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AxiosError: Request failed with status code 401

      34 |     it('deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas', async () => {
      35 |         // --- 1. Criar uma transa√ß√£o com tokenEmpresaA ---
    > 36 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      37 |             description: 'Transa√ß√£o de Teste Empresa A',
      38 |             amount: 100,
      39 |             type: 'expense',

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento-simples.test.js:36:35)

  ‚óè 2. Teste de Isolamento de Dados (Simples) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AxiosError: Request failed with status code 401

      87 |      */
      88 |     it('deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A', async () => {
    > 89 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
         |                           ^
      90 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      91 |         });
      92 |

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento-simples.test.js:89:27)

 FAIL  Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (12 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (4 ms)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AxiosError: Request failed with status code 401

      27 |         console.log('\n--- Criando transa√ß√£o para Empresa A ---');
      28 |
    > 29 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      30 |             description: 'Transa√ß√£o de Teste Empresa A',
      31 |             amount: 100,
      32 |             type: 'expense', // Campo obrigat√≥rio, usando o nome padronizado

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.test.js:29:35)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AxiosError: Request failed with status code 401

      107 |         // A requisi√ß√£o para listar transa√ß√µes da Empresa B precisa do token da Empresa B
      108 |         // para que o backend possa filtrar corretamente.
    > 109 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
          |                           ^
      110 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      111 |         });
      112 |

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.test.js:109:27)

 PASS  Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    ‚àö deve criar uma transa√ß√£o para cada empresa (225 ms)
    ‚àö deve impedir que uma empresa acesse a transa√ß√£o de outra (313 ms)
    ‚àö deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes (155 ms)

 PASS  Testes/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    ‚àö deve CRIAR uma nova transa√ß√£o com sucesso (76 ms)
    ‚àö deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (46 ms)
    ‚àö deve LISTAR as transa√ß√µes do usu√°rio logado (42 ms)
    ‚àö deve OBTER uma transa√ß√£o espec√≠fica pelo ID (44 ms)
    ‚àö deve ATUALIZAR uma transa√ß√£o existente (88 ms)
    ‚àö deve EXCLUIR uma transa√ß√£o existente (146 ms)

 PASS  Testes/metas.test.js
  5. M√≥dulo de Metas (CRUD)
    ‚àö deve CRIAR uma nova meta com sucesso (87 ms)
    ‚àö deve LISTAR as metas do usu√°rio logado (53 ms)
    ‚àö deve ATUALIZAR uma meta existente (86 ms)
    ‚àö deve EXCLUIR uma meta existente (140 ms)

 PASS  Testes/auth.legacy.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (34 ms)
    ‚àö deve falhar o login com senha incorreta (83 ms)
    ‚àö deve realizar o login com sucesso para a Empresa A (140 ms)
    ‚àö deve proteger rotas, barrando acesso sem token (2 ms)

 PASS  Testes/api.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (45 ms)
    ‚àö deve falhar o login com senha incorreta (92 ms)
    ‚àö deve realizar o login com sucesso para a Empresa A (110 ms)
    ‚àö deve proteger rotas, barrando acesso sem token (2 ms)

 PASS  Testes/clients.test.js
  7. M√≥dulo de Clientes/Fornecedores (TDD)
    ‚àö deve CRIAR um novo cliente com sucesso (85 ms)
    ‚àö deve LISTAR os clientes da empresa (53 ms)

Test Suites: 5 failed, 6 passed, 11 total
Tests:       9 failed, 25 passed, 34 total
Snapshots:   0 total
Time:        25.069 s, estimated 26 s
Ran all test suites.
