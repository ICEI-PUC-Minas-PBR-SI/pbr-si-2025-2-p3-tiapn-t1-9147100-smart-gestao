
--- üöÄ [SETUP] Populando banco de dados de teste em mem√≥ria ---
‚úÖ Empresa Padr√£o 1 criada para os testes.
‚úÖ Empresa Padr√£o 2 criada para os testes.
--- ‚úÖ [SETUP] Dados de teste salvos em test-setup.json ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---
  console.log
    
    --- Criando transa√ß√£o para Empresa A ---

      at Object.log (isolamento.test.js:31:17)

  console.log
    
    --- Tentando listar transa√ß√µes com token da Empresa B ---

      at Object.log (isolamento.test.js:108:17)

  console.log
    Enviando: GET para http://localhost:5001/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:109:17)


--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---
  console.log
    Executando teste para: RF-009 - CRIAR Cliente (Pendente)

      at Object.log (clients.test.js:25:13)

  console.log
    Executando teste para: RF-009 - LISTAR Clientes (Pendente)

      at Object.log (clients.test.js:45:13)


--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---
  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:16:17)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:129:17)


--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---
  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (auth.legacy.test.js:32:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (auth.legacy.test.js:35:17)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (auth.legacy.test.js:78:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (auth.legacy.test.js:91:17)


--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- üöÄ [ENV] Iniciando e conectando ao MongoDB em Mem√≥ria ---

--- üßπ [ENV] Desconectando e parando o MongoDB ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---

--- FIM DOS TESTES AUTOMATIZADOS (COM FALHAS) ---
(node:37496) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL Testes/auth.test.js
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    √ó deve criar um SessionToken no banco de dados ap√≥s o login (24 ms)
    √ó deve invalidar o SessionToken no banco de dados ap√≥s o logout (11 ms)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve criar um SessionToken no banco de dados ap√≥s o login

    AggregateError: Error

      41 |   test('deve criar um SessionToken no banco de dados ap√≥s o login', async () => {
      42 |     // 1. Realiza o login
    > 43 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, {
         |                           ^
      44 |       email: userA.email,
      45 |       password: userA.password,
      46 |     });

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:43:27)

    Cause:
    AggregateError:


  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve invalidar o SessionToken no banco de dados ap√≥s o logout

    AggregateError: Error

      66 |   test('deve invalidar o SessionToken no banco de dados ap√≥s o logout', async () => {
      67 |     // 1. Realiza o login para obter um refresh token v√°lido
    > 68 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, { // Corre√ß√£o do typo
         |                           ^
      69 |       email: userA.email,
      70 |       password: userA.password,
      71 |     });

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:68:27)

    Cause:
    AggregateError:


FAIL Testes/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    √ó deve CRIAR uma nova transa√ß√£o com sucesso (15 ms)
    √ó deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (2 ms)
    √ó deve LISTAR as transa√ß√µes do usu√°rio logado (1 ms)
    √ó deve OBTER uma transa√ß√£o espec√≠fica pelo ID (1 ms)
    √ó deve ATUALIZAR uma transa√ß√£o existente
    √ó deve EXCLUIR uma transa√ß√£o existente (1 ms)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve CRIAR uma nova transa√ß√£o com sucesso

    AggregateError: Error

      45 |         };
      46 |
    > 47 |         const response = await axios.post(`${API_URL}/transactions`, transactionData, {
         |                          ^
      48 |             headers: { Authorization: `Bearer ${userToken}` }
      49 |         });
      50 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (transactions.test.js:47:26)

    Cause:
    AggregateError:


  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos

    TypeError: Cannot read properties of undefined (reading 'status')

      76 |             fail('A cria√ß√£o de transa√ß√£o com dados inv√°lidos deveria ter falhado.');
      77 |         } catch (error) {
    > 78 |             expect(error.response.status).toBe(500); // Mongoose validation error results in 500 in this setup
         |                                   ^
      79 |         }
      80 |     });
      81 |

      at Object.status (transactions.test.js:78:35)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve LISTAR as transa√ß√µes do usu√°rio logado

    expect(received).toBeDefined()

    Received: undefined

      82 |     it('deve LISTAR as transa√ß√µes do usu√°rio logado', async () => {
      83 |         // Este teste depende que o anterior tenha criado uma transa√ß√£o
    > 84 |         expect(createdTransactionId).toBeDefined();
         |                                      ^
      85 |
      86 |         const response = await axios.get(`${API_URL}/transactions`, {
      87 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.toBeDefined (transactions.test.js:84:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve OBTER uma transa√ß√£o espec√≠fica pelo ID

    expect(received).toBeDefined()

    Received: undefined

       98 |
       99 |     it('deve OBTER uma transa√ß√£o espec√≠fica pelo ID', async () => {
    > 100 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      101 |
      102 |         const response = await axios.get(`${API_URL}/transactions/${createdTransactionId}`, {
      103 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.toBeDefined (transactions.test.js:100:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve ATUALIZAR uma transa√ß√£o existente

    expect(received).toBeDefined()

    Received: undefined

      110 |
      111 |     it('deve ATUALIZAR uma transa√ß√£o existente', async () => {
    > 112 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      113 |
      114 |         const updatedData = {
      115 |             description: 'Venda de consultoria (Valor Atualizado)',

      at Object.toBeDefined (transactions.test.js:112:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve EXCLUIR uma transa√ß√£o existente

    expect(received).toBeDefined()

    Received: undefined

      128 |
      129 |     it('deve EXCLUIR uma transa√ß√£o existente', async () => {
    > 130 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      131 |
      132 |         const response = await axios.delete(`${API_URL}/transactions/${createdTransactionId}`, {
      133 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.toBeDefined (transactions.test.js:130:38)

FAIL Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (24 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (3 ms)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AggregateError: Error

      31 |         console.log('\n--- Criando transa√ß√£o para Empresa A ---');
      32 |
    > 33 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      34 |             description: 'Transa√ß√£o de Teste Empresa A',
      35 |             amount: 100,
      36 |             type: 'expense', // Campo obrigat√≥rio, usando o nome padronizado

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.test.js:33:35)

    Cause:
    AggregateError:


  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AggregateError: Error

      111 |         // A requisi√ß√£o para listar transa√ß√µes da Empresa B precisa do token da Empresa B
      112 |         // para que o backend possa filtrar corretamente.
    > 113 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
          |                           ^
      114 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      115 |         });
      116 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.test.js:113:27)

    Cause:
    AggregateError:


FAIL Testes/metas.test.js
  5. M√≥dulo de Metas (CRUD)
    √ó deve CRIAR uma nova meta com sucesso (12 ms)
    √ó deve LISTAR as metas do usu√°rio logado (1 ms)
    √ó deve ATUALIZAR uma meta existente (1 ms)
    √ó deve EXCLUIR uma meta existente

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve CRIAR uma nova meta com sucesso

    AggregateError: Error

      30 |         };
      31 |
    > 32 |         const response = await axios.post(`${API_URL}/meta`, goalData, {
         |                          ^
      33 |             headers: { Authorization: `Bearer ${userToken}` }
      34 |         });
      35 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (metas.test.js:32:26)

    Cause:
    AggregateError:


  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve LISTAR as metas do usu√°rio logado

    expect(received).toBeDefined()

    Received: undefined

      43 |
      44 |     it('deve LISTAR as metas do usu√°rio logado', async () => {
    > 45 |         expect(createdGoalId).toBeDefined();
         |                               ^
      46 |
      47 |         const response = await axios.get(`${API_URL}/meta`, {
      48 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.toBeDefined (metas.test.js:45:31)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve ATUALIZAR uma meta existente

    expect(received).toBeDefined()

    Received: undefined

      56 |
      57 |     it('deve ATUALIZAR uma meta existente', async () => {
    > 58 |         expect(createdGoalId).toBeDefined();
         |                               ^
      59 |
      60 |         const updatedData = {
      61 |             title: 'Economizar para novo maquin√°rio (URGENTE)',

      at Object.toBeDefined (metas.test.js:58:31)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve EXCLUIR uma meta existente

    expect(received).toBeDefined()

    Received: undefined

      73 |
      74 |     it('deve EXCLUIR uma meta existente', async () => {
    > 75 |         expect(createdGoalId).toBeDefined();
         |                               ^
      76 |
      77 |         const response = await axios.delete(`${API_URL}/meta/${createdGoalId}`, {
      78 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.toBeDefined (metas.test.js:75:31)

FAIL Testes/clients.test.js
  7. M√≥dulo de Clientes/Fornecedores (TDD)
    √ó deve CRIAR um novo cliente com sucesso (11 ms)
    √ó deve LISTAR os clientes da empresa (4 ms)

  ‚óè 7. M√≥dulo de Clientes/Fornecedores (TDD) ‚Ä∫ deve CRIAR um novo cliente com sucesso

    AggregateError: Error

      31 |     };
      32 |
    > 33 |     const response = await axios.post(`${API_URL}/clients`, newClient, {
         |                      ^
      34 |       headers: { Authorization: `Bearer ${companyA.token}` },
      35 |     });
      36 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (clients.test.js:33:22)

    Cause:
    AggregateError:


  ‚óè 7. M√≥dulo de Clientes/Fornecedores (TDD) ‚Ä∫ deve LISTAR os clientes da empresa

    AggregateError: Error

      44 |   test('deve LISTAR os clientes da empresa', async () => {
      45 |     console.log('Executando teste para: RF-009 - LISTAR Clientes (Pendente)');
    > 46 |     const response = await axios.get(`${API_URL}/clients`, {
         |                      ^
      47 |       headers: { Authorization: `Bearer ${companyA.token}` },
      48 |     });
      49 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (clients.test.js:46:22)

    Cause:
    AggregateError:


FAIL Testes/isolamento-simples.test.js
  2. Teste de Isolamento de Dados (Simples)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (17 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (3 ms)

  ‚óè 2. Teste de Isolamento de Dados (Simples) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AggregateError: Error

      39 |     it('deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas', async () => {
      40 |         // --- 1. Criar uma transa√ß√£o com tokenEmpresaA ---
    > 41 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      42 |             description: 'Transa√ß√£o de Teste Empresa A',
      43 |             amount: 100,
      44 |             type: 'expense',

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento-simples.test.js:41:35)

    Cause:
    AggregateError:


  ‚óè 2. Teste de Isolamento de Dados (Simples) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AggregateError: Error

      93 |      */
      94 |     it('deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A', async () => {
    > 95 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
         |                           ^
      96 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      97 |         });
      98 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento-simples.test.js:95:27)

    Cause:
    AggregateError:


FAIL Testes/reports.test.js
  8. M√≥dulo de Relat√≥rios (TDD)
    √ó deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF (9 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios (TDD) ‚Ä∫ deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF

    AggregateError: Error

      22 |
      23 |   test('deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF', async () => {
    > 24 |     const response = await axios.get(`${API_URL}/reports/export/pdf`, {
         |                      ^
      25 |       headers: { Authorization: `Bearer ${companyA.token}` },
      26 |       responseType: 'arraybuffer', // Importante para receber arquivos bin√°rios
      27 |     });

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (reports.test.js:24:22)

    Cause:
    AggregateError:


FAIL Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    √ó deve criar uma transa√ß√£o para cada empresa
    √ó deve impedir que uma empresa acesse a transa√ß√£o de outra (1 ms)
    √ó deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes

  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve criar uma transa√ß√£o para cada empresa

    AggregateError: Error

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

    Cause:
    AggregateError:


  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve impedir que uma empresa acesse a transa√ß√£o de outra

    AggregateError: Error

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

    Cause:
    AggregateError:


  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes

    AggregateError: Error

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

    Cause:
    AggregateError:


FAIL Testes/auth.legacy.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    √ó deve barrar o cadastro de um usu√°rio com e-mail j√° existente (20 ms)
    √ó deve falhar o login com senha incorreta (2 ms)
    √ó deve realizar o login com sucesso para a Empresa A (2 ms)
    √ó deve proteger rotas, barrando acesso sem token (2 ms)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve barrar o cadastro de um usu√°rio com e-mail j√° existente

    TypeError: Cannot read properties of undefined (reading 'status')

      51 |         } catch (error) {
      52 |             // Espera-se um erro 409 (Conflict)
    > 53 |             expect(error.response.status).toBe(409);
         |                                   ^
      54 |             expect(error.response.data.message).toContain('E-mail j√° cadastrado');
      55 |         }
      56 |     });

      at Object.status (auth.legacy.test.js:53:35)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve falhar o login com senha incorreta

    TypeError: Cannot read properties of undefined (reading 'status')

      66 |             fail('O login com senha incorreta deveria ter falhado.');
      67 |         } catch (error) {
    > 68 |             expect(error.response.status).toBe(401);
         |                                   ^
      69 |             expect(error.response.data.message).toBe('Credenciais inv√°lidas.');
      70 |         }
      71 |     });

      at Object.status (auth.legacy.test.js:68:35)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve realizar o login com sucesso para a Empresa A

    AggregateError: Error

      78 |         console.log('\n--- Teste: Login com sucesso ---');
      79 |
    > 80 |         const response = await axios.post(`${API_URL}/auth/login`, requestBody);
         |                          ^
      81 |
      82 |         // Espera-se que o login retorne status 200 (OK) e os tokens
      83 |         expect(response.status).toBe(200);

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.legacy.test.js:80:26)

    Cause:
    AggregateError:


  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve proteger rotas, barrando acesso sem token

    TypeError: Cannot read properties of undefined (reading 'status')

       97 |         } catch (error) {
       98 |             // O middleware de autentica√ß√£o deve retornar 401 (Unauthorized)
    >  99 |             expect(error.response.status).toBe(401);
          |                                   ^
      100 |             expect(error.response.data.message).toBe('Acesso negado. Token de autentica√ß√£o n√£o fornecido ou em formato inv√°lido.');
      101 |             console.log('‚úÖ Acesso sem token foi barrado como esperado (Status 401).');
      102 |         }

      at Object.status (auth.legacy.test.js:99:35)

FAIL Testes/api.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    √ó RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (1 ms)
    √ó deve barrar o cadastro de um usu√°rio com e-mail j√° existente
    √ó deve falhar o login com senha incorreta
    √ó deve realizar o login com sucesso para a Empresa A
    √ó deve proteger rotas, barrando acesso sem token

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ RF-001: deve ter cadastrado a Empresa A com sucesso no setup global

    ReferenceError: SETUP_FILE is not defined

      18 |     // Antes de tudo, l√™ os dados das empresas criadas pelo setup global
      19 |     beforeAll(() => {
    > 20 |         const testData = JSON.parse(fs.readFileSync(SETUP_FILE, 'utf8'));
         |                                                     ^
      21 |         API_URL = testData.apiUrl;
      22 |         empresaA = testData.companyA;
      23 |         tokenEmpresaA = empresaA.token;

      at Object.SETUP_FILE (api.test.js:20:53)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve barrar o cadastro de um usu√°rio com e-mail j√° existente

    ReferenceError: SETUP_FILE is not defined

      18 |     // Antes de tudo, l√™ os dados das empresas criadas pelo setup global
      19 |     beforeAll(() => {
    > 20 |         const testData = JSON.parse(fs.readFileSync(SETUP_FILE, 'utf8'));
         |                                                     ^
      21 |         API_URL = testData.apiUrl;
      22 |         empresaA = testData.companyA;
      23 |         tokenEmpresaA = empresaA.token;

      at Object.SETUP_FILE (api.test.js:20:53)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve falhar o login com senha incorreta

    ReferenceError: SETUP_FILE is not defined

      18 |     // Antes de tudo, l√™ os dados das empresas criadas pelo setup global
      19 |     beforeAll(() => {
    > 20 |         const testData = JSON.parse(fs.readFileSync(SETUP_FILE, 'utf8'));
         |                                                     ^
      21 |         API_URL = testData.apiUrl;
      22 |         empresaA = testData.companyA;
      23 |         tokenEmpresaA = empresaA.token;

      at Object.SETUP_FILE (api.test.js:20:53)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve realizar o login com sucesso para a Empresa A

    ReferenceError: SETUP_FILE is not defined

      18 |     // Antes de tudo, l√™ os dados das empresas criadas pelo setup global
      19 |     beforeAll(() => {
    > 20 |         const testData = JSON.parse(fs.readFileSync(SETUP_FILE, 'utf8'));
         |                                                     ^
      21 |         API_URL = testData.apiUrl;
      22 |         empresaA = testData.companyA;
      23 |         tokenEmpresaA = empresaA.token;

      at Object.SETUP_FILE (api.test.js:20:53)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve proteger rotas, barrando acesso sem token

    ReferenceError: SETUP_FILE is not defined

      18 |     // Antes de tudo, l√™ os dados das empresas criadas pelo setup global
      19 |     beforeAll(() => {
    > 20 |         const testData = JSON.parse(fs.readFileSync(SETUP_FILE, 'utf8'));
         |                                                     ^
      21 |         API_URL = testData.apiUrl;
      22 |         empresaA = testData.companyA;
      23 |         tokenEmpresaA = empresaA.token;

      at Object.SETUP_FILE (api.test.js:20:53)

FAIL Testes/isolamento.legacy.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    √ó deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (10 ms)
    √ó deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (3 ms)

  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas

    AggregateError: Error

      43 |     it('deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas', async () => {
      44 |         // --- 1. Criar uma transa√ß√£o com tokenEmpresaA ---
    > 45 |         const createTransaction = await axios.post(`${API_URL}/transactions`, {
         |                                   ^
      46 |             description: 'Transa√ß√£o de Teste Empresa A',
      47 |             amount: 100,
      48 |             type: 'expense',

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.legacy.test.js:45:35)

    Cause:
    AggregateError:


  ‚óè 2. Teste de Isolamento de Dados (Transa√ß√µes) ‚Ä∫ deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A

    AggregateError: Error

      101 |      */
      102 |     it('deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A', async () => {
    > 103 |         const responseB = await axios.get(`${API_URL}/transactions`, { 
          |                           ^
      104 |             headers: { Authorization: `Bearer ${tokenEmpresaB}` }
      105 |         });
      106 |

      at AxiosError.from (../node_modules/axios/lib/core/AxiosError.js:96:14)
      at RedirectableRequest.handleRequestError (../node_modules/axios/lib/adapters/http.js:817:25)
      at ClientRequest.eventHandlers.<computed> (../node_modules/follow-redirects/index.js:49:24)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (isolamento.legacy.test.js:103:27)

    Cause:
    AggregateError:


Test Suites: 11 failed, 11 total
Tests:       33 failed, 1 passed, 34 total
Snapshots:   0 total
Time:        5.734 s, estimated 20 s
Ran all test suites.
