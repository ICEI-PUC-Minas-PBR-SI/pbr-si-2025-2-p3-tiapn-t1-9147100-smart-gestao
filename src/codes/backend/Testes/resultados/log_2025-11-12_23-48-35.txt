
--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
(node:13900) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
POST /api/auth/login 200 99.673 ms - 604
[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
POST /api/auth/login 200 101.035 ms - 604
[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
POST /api/auth/logout 200 21.072 ms - 81

--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
[LOG] A√ß√£o: LOGOUT_USER | Usu√°rio: N/A
PASS Testes/1-auth/auth.test.js
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    ‚àö deve criar um SessionToken no banco de dados ap√≥s o login (135 ms)
    ‚àö deve invalidar o SessionToken no banco de dados ap√≥s o logout (132 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
  console.log
    
    --- Teste: Solicitar reset para e-mail inv√°lido ---

      at Object.log (Testes/1-auth/password.test.js:25:13)

POST /api/auth/forgot-password 404 14.257 ms - 39
  console.log
    ‚úÖ Falhou como esperado para e-mail inexistente (Status 404).

      at Object.log (Testes/1-auth/password.test.js:34:15)

  console.log
    
    --- Teste: Gerar token de reset com sucesso ---

      at Object.log (Testes/1-auth/password.test.js:39:13)

POST /api/auth/forgot-password 200 33.896 ms - 140
  console.log
    ‚úÖ Token de reset gerado e salvo no banco de dados.

      at Object.log (Testes/1-auth/password.test.js:49:13)

  console.log
    
    --- Teste: Resetar senha com token v√°lido ---

      at Object.log (Testes/1-auth/password.test.js:53:13)

POST /api/auth/forgot-password 200 31.222 ms - 140
POST /api/auth/reset-password/b4792b4340285e1f8537f237c5b328ac060825fe5cf0c9942e8cbf7b8089932d 200 101.790 ms - 41
  console.log
    ‚úÖ Senha resetada com sucesso via API.

      at Object.log (Testes/1-auth/password.test.js:70:13)

POST /api/auth/reset-password/b4792b4340285e1f8537f237c5b328ac060825fe5cf0c9942e8cbf7b8089932d 400 20.768 ms - 42
  console.log
    ‚úÖ Token de reset foi invalidado no banco.

      at Object.log (Testes/1-auth/password.test.js:74:13)

POST /api/auth/login 200 101.783 ms - 604
  console.log
    ‚úÖ Login com a nova senha realizado com sucesso.

      at Object.log (Testes/1-auth/password.test.js:84:13)


--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
PASS Testes/1-auth/password.test.js
  9. M√≥dulo de Recupera√ß√£o de Senha
    ‚àö deve falhar ao solicitar reset para um e-mail inexistente (52 ms)
    ‚àö deve gerar e salvar um token de reset para um e-mail v√°lido (40 ms)
    ‚àö deve resetar a senha com um token v√°lido e permitir login com a nova senha (269 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
POST /api/clients 201 32.613 ms - 328
[LOG] A√ß√£o: CREATE_CLIENT | Usu√°rio: 69154708cbe477c8daf0b53f
GET /api/clients 200 28.162 ms - 569
PUT /api/clients/69154708cbe477c8daf0b54b 200 32.746 ms - 371
[LOG] A√ß√£o: UPDATE_CLIENT | Usu√°rio: 69154708cbe477c8daf0b53f
DELETE /api/clients/69154708cbe477c8daf0b54b 200 31.859 ms - 70
GET /api/clients/69154708cbe477c8daf0b54b 404 2.124 ms - 175

--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
[LOG] A√ß√£o: DELETE_CLIENT | Usu√°rio: 69154708cbe477c8daf0b53f
PASS Testes/2-features/clients.test.js
  7. M√≥dulo de Clientes/Fornecedores
    ‚àö deve CRIAR um novo cliente com sucesso (45 ms)
    ‚àö deve LISTAR os clientes da empresa (31 ms)
    ‚àö deve ATUALIZAR um cliente existente (36 ms)
    ‚àö deve EXCLUIR um cliente existente (49 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
[LOG] A√ß√£o: CREATE_GOAL | Usu√°rio: 69154709cbe477c8daf0b573
POST /api/goals 201 48.265 ms - 404
GET /api/goals 200 28.049 ms - 406
[LOG] A√ß√£o: UPDATE_GOAL | Usu√°rio: 69154709cbe477c8daf0b573
PUT /api/goals/69154709cbe477c8daf0b57f 200 47.880 ms - 414
[LOG] A√ß√£o: DELETE_GOAL | Usu√°rio: 69154709cbe477c8daf0b573
DELETE /api/goals/69154709cbe477c8daf0b57f 200 47.499 ms - 67
GET /api/goals/69154709cbe477c8daf0b57f 404 27.207 ms - 65

--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
PASS Testes/2-features/goals.test.js
  5. M√≥dulo de Metas (CRUD)
    ‚àö deve CRIAR uma nova meta com sucesso (60 ms)
    ‚àö deve LISTAR as metas do usu√°rio logado (31 ms)
    ‚àö deve ATUALIZAR uma meta existente (51 ms)
    ‚àö deve EXCLUIR uma meta existente (89 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
POST /api/transactions 201 48.363 ms - 450
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
POST /api/transactions 400 16.130 ms - 277
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
GET /api/transactions 200 27.853 ms - 853
GET /api/transactions/6915470acbe477c8daf0b5b5 200 27.253 ms - 450
[LOG] A√ß√£o: UPDATE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
PUT /api/transactions/6915470acbe477c8daf0b5b5 200 50.210 ms - 452
[LOG] A√ß√£o: UPDATE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
[LOG] A√ß√£o: DELETE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
DELETE /api/transactions/6915470acbe477c8daf0b5b5 200 48.850 ms - 73
[LOG] A√ß√£o: DELETE_TRANSACTION | Usu√°rio: 6915470acbe477c8daf0b5a9
GET /api/transactions/6915470acbe477c8daf0b5b5 404 26.507 ms - 71

--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
PASS Testes/2-features/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    ‚àö deve CRIAR uma nova transa√ß√£o com sucesso (63 ms)
    ‚àö deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (31 ms)
    ‚àö deve LISTAR as transa√ß√µes do usu√°rio logado (32 ms)
    ‚àö deve OBTER uma transa√ß√£o espec√≠fica pelo ID (30 ms)
    ‚àö deve ATUALIZAR uma transa√ß√£o existente (55 ms)
    ‚àö deve EXCLUIR uma transa√ß√£o existente (80 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (Testes/3-security/multi-tenant.test.js:19:17)

POST /api/auth/register 201 150.359 ms - 82
[LOG] A√ß√£o: REGISTER_COMPANY_USER | Usu√°rio: N/A
POST /api/auth/login 200 93.157 ms - 628
  console.log
    ‚úÖ Empresa 1 (Empresa Teste 1763002123818) cadastrada e logada.

      at Object.log (Testes/3-security/multi-tenant.test.js:48:21)

[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
POST /api/auth/register 201 137.173 ms - 82
[LOG] A√ß√£o: REGISTER_COMPANY_USER | Usu√°rio: N/A
POST /api/auth/login 200 93.191 ms - 628
  console.log
    ‚úÖ Empresa 2 (Empresa Teste 1763002124075) cadastrada e logada.

      at Object.log (Testes/3-security/multi-tenant.test.js:48:21)

[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
POST /api/auth/register 201 156.581 ms - 82
[LOG] A√ß√£o: REGISTER_COMPANY_USER | Usu√°rio: N/A
POST /api/auth/login 200 109.712 ms - 628
  console.log
    ‚úÖ Empresa 3 (Empresa Teste 1763002124313) cadastrada e logada.

      at Object.log (Testes/3-security/multi-tenant.test.js:48:21)

  console.log
    --- Configura√ß√£o multi-tenant conclu√≠da ---

      at Object.log (Testes/3-security/multi-tenant.test.js:50:17)

  console.log
    
    --- Criando transa√ß√µes individuais para cada empresa ---

      at Object.log (Testes/3-security/multi-tenant.test.js:55:17)

[LOG] A√ß√£o: LOGIN_USER | Usu√°rio: N/A
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470bcbe477c8daf0b5fb
POST /api/transactions 201 47.891 ms - 421
  console.log
    Transa√ß√£o criada para Empresa Teste 1763002123818. ID: 6915470ccbe477c8daf0b621

      at Object.log (Testes/3-security/multi-tenant.test.js:76:21)

[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470bcbe477c8daf0b5fb
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470ccbe477c8daf0b609
POST /api/transactions 201 46.487 ms - 420
  console.log
    Transa√ß√£o criada para Empresa Teste 1763002124075. ID: 6915470ccbe477c8daf0b628

      at Object.log (Testes/3-security/multi-tenant.test.js:76:21)

[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470ccbe477c8daf0b609
[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470ccbe477c8daf0b617
POST /api/transactions 201 47.438 ms - 413
  console.log
    Transa√ß√£o criada para Empresa Teste 1763002124313. ID: 6915470ccbe477c8daf0b62f

      at Object.log (Testes/3-security/multi-tenant.test.js:76:21)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.log (Testes/3-security/multi-tenant.test.js:82:17)

  console.log
    
    Verificando a transa√ß√£o 6915470ccbe477c8daf0b621 da Empresa Teste 1763002123818

      at Object.log (Testes/3-security/multi-tenant.test.js:89:21)

[LOG] A√ß√£o: CREATE_TRANSACTION | Usu√°rio: 6915470ccbe477c8daf0b617
GET /api/transactions/6915470ccbe477c8daf0b621 404 28.074 ms - 71
  console.log
    - OK: Empresa Teste 1763002124075 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

GET /api/transactions/6915470ccbe477c8daf0b621 404 28.299 ms - 71
  console.log
    - OK: Empresa Teste 1763002124313 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    Verificando a transa√ß√£o 6915470ccbe477c8daf0b628 da Empresa Teste 1763002124075

      at Object.log (Testes/3-security/multi-tenant.test.js:89:21)

GET /api/transactions/6915470ccbe477c8daf0b628 404 28.441 ms - 71
  console.log
    - OK: Empresa Teste 1763002123818 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

GET /api/transactions/6915470ccbe477c8daf0b628 404 27.843 ms - 71
  console.log
    - OK: Empresa Teste 1763002124313 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    Verificando a transa√ß√£o 6915470ccbe477c8daf0b62f da Empresa Teste 1763002124313

      at Object.log (Testes/3-security/multi-tenant.test.js:89:21)

GET /api/transactions/6915470ccbe477c8daf0b62f 404 27.209 ms - 71
  console.log
    - OK: Empresa Teste 1763002123818 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

GET /api/transactions/6915470ccbe477c8daf0b62f 404 29.318 ms - 71
  console.log
    - OK: Empresa Teste 1763002124075 foi bloqueada (Status 404).

      at Object.log (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    --- Validando listagem de transa√ß√µes ---

      at Object.log (Testes/3-security/multi-tenant.test.js:114:17)

GET /api/transactions 200 28.787 ms - 423
  console.log
    - OK: Empresa Teste 1763002123818 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (Testes/3-security/multi-tenant.test.js:126:21)

GET /api/transactions 200 28.708 ms - 422
  console.log
    - OK: Empresa Teste 1763002124075 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (Testes/3-security/multi-tenant.test.js:126:21)

GET /api/transactions 200 29.129 ms - 415
  console.log
    - OK: Empresa Teste 1763002124313 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (Testes/3-security/multi-tenant.test.js:126:21)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (Testes/3-security/multi-tenant.test.js:132:17)

DELETE /api/auth/users/6915470bcbe477c8daf0b5fb 200 82.515 ms - 80
  console.log
    - ‚úÖ Empresa Empresa Teste 1763002123818 e dados associados exclu√≠dos com sucesso.

      at Object.log (Testes/3-security/multi-tenant.test.js:139:25)

[LOG] A√ß√£o: DELETE_USER_BY_ID | Usu√°rio: 6915470bcbe477c8daf0b5fb
DELETE /api/auth/users/6915470ccbe477c8daf0b609 200 82.589 ms - 80
  console.log
    - ‚úÖ Empresa Empresa Teste 1763002124075 e dados associados exclu√≠dos com sucesso.

      at Object.log (Testes/3-security/multi-tenant.test.js:139:25)

[LOG] A√ß√£o: DELETE_USER_BY_ID | Usu√°rio: 6915470ccbe477c8daf0b609
DELETE /api/auth/users/6915470ccbe477c8daf0b617 200 85.096 ms - 80
  console.log
    - ‚úÖ Empresa Empresa Teste 1763002124313 e dados associados exclu√≠dos com sucesso.

      at Object.log (Testes/3-security/multi-tenant.test.js:139:25)


--- üßπ [ENV] Desconectando do banco de dados ---
Falha cr√≠tica ao gravar log de auditoria: MongoClientClosedError: Operation interrupted because client was closed
    at ConnectionPool.closeCheckedOutConnections (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongodb\src\cmap\connection_pool.ts:495:20)
    at Server.closeCheckedOutConnections (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongodb\src\sdam\server.ts:251:22)
    at Topology.closeCheckedOutConnections (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongodb\src\sdam\topology.ts:496:21)
    at MongoClient._close (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongodb\src\mongo_client.ts:782:20)
    at MongoClient.close (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongodb\src\mongo_client.ts:764:29)
    at NativeConnection.doClose (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongoose\lib\drivers\node-mongodb-native\connection.js:208:21)
    at NativeConnection._close (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongoose\lib\connection.js:1264:18)
    at NativeConnection.close (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongoose\lib\connection.js:1229:15)
    at F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongoose\lib\mongoose.js:471:60
    at Array.map (<anonymous>)
    at Mongoose.disconnect (F:\Programacao\GitHub\pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao\src\codes\backend\node_modules\mongoose\lib\mongoose.js:471:43)
    at Server.<anonymous> (file:///F:/Programacao/GitHub/pbr-si-2025-2-p3-tiapn-t1-9147100-smart-gestao/src/codes/backend/server.js:157:24)
    at Object.onceWrapper (node:events:633:28)
    at Server.emit (node:events:519:28)
    at emitCloseNT (node:net:2419:8)
    at processTicksAndRejections (node:internal/process/task_queues:89:21) {
  errorLabelSet: Set(0) {}
}
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
PASS Testes/3-security/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    ‚àö deve criar uma transa√ß√£o para cada empresa (157 ms)
    ‚àö deve impedir que uma empresa acesse a transa√ß√£o de outra (213 ms)
    ‚àö deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes (100 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) criados e salvos em test-setup.json.
‚è≥ Iniciando servidor Smart Gest√£o (startServer)...
Conex√£o com o MongoDB estabelecida com sucesso.
Verificando permiss√µes de sistema...
Permiss√µes de sistema j√° existem. Nenhuma a√ß√£o necess√°ria.
‚úÖ Conex√£o com o banco estabelecida!
üöÄ Servidor rodando na porta 5000
üì° Verifique em: http://localhost:5000/api/health
   - [OK] Servidor iniciado em-processo para execu√ß√£o dos testes.
GET /api/reports/export/transactions-pdf 200 256.881 ms - -
GET /api/reports/export/clients-pdf 200 47.671 ms - -
GET /api/reports/export/invoice/6915470ecbe477c8daf0b67e 200 57.678 ms - -

--- üßπ [ENV] Desconectando do banco de dados ---
‚úÖ Servidor e conex√£o com MongoDB encerrados (stopServer).
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
FAIL Testes/4-reports/reports.test.js
  8. M√≥dulo de Relat√≥rios
    √ó deve chamar o servi√ßo de PDF com os dados corretos para o RELAT√ìRIO DE TRANSA√á√ïES (274 ms)
    √ó deve chamar o servi√ßo de PDF com os dados corretos para o RELAT√ìRIO DE CLIENTES (51 ms)
    √ó deve chamar o servi√ßo de PDF com os dados corretos para a FATURA (60 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios ‚Ä∫ deve chamar o servi√ßo de PDF com os dados corretos para o RELAT√ìRIO DE TRANSA√á√ïES

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      57 |     });
      58 |
    > 59 |     expect(generateFinancialReportPDF).toHaveBeenCalled();
         |                                        ^
      60 |     const capturedData = generateFinancialReportPDF.mock.calls[0][0];
      61 |     expect(capturedData.company.name).toBe(companyA.name);
      62 |     expect(capturedData.transactions).toBeInstanceOf(Array);

      at Object.toHaveBeenCalled (Testes/4-reports/reports.test.js:59:40)

  ‚óè 8. M√≥dulo de Relat√≥rios ‚Ä∫ deve chamar o servi√ßo de PDF com os dados corretos para o RELAT√ìRIO DE CLIENTES

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      74 |     });
      75 |
    > 76 |     expect(generateClientsReportPDF).toHaveBeenCalled();
         |                                      ^
      77 |     const capturedData = generateClientsReportPDF.mock.calls[0][0];
      78 |     expect(capturedData.company.name).toBe(companyA.name);
      79 |     expect(capturedData.clients).toBeInstanceOf(Array);

      at Object.toHaveBeenCalled (Testes/4-reports/reports.test.js:76:38)

  ‚óè 8. M√≥dulo de Relat√≥rios ‚Ä∫ deve chamar o servi√ßo de PDF com os dados corretos para a FATURA

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      91 |     });
      92 |
    > 93 |     expect(generateInvoicePDF).toHaveBeenCalled();
         |                                ^
      94 |     const capturedData = generateInvoicePDF.mock.calls[0][0];
      95 |     expect(capturedData.company.name).toBe(companyA.name);
      96 |     expect(capturedData.transaction.description).toBe(companyA.testTransaction.description);

      at Object.toHaveBeenCalled (Testes/4-reports/reports.test.js:93:32)

Test Suites: 1 failed, 6 passed, 7 total
Tests:       3 failed, 22 passed, 25 total
Snapshots:   0 total
Time:        11.201 s
Ran all test suites.

--- FIM DOS TESTES AUTOMATIZADOS (Status: Falha) ---
