
--- ðŸš€ [SETUP] Conectando e populando o banco de dados de DESENVOLVIMENTO para os testes ---
âœ… Empresa PadrÃ£o 1 criada para os testes.
âœ… Empresa PadrÃ£o 2 criada para os testes.
--- âœ… [SETUP] Dados de teste salvos em test-setup.json ---
  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:16:17)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:129:17)

  console.log
    
    --- Teste: Validar setup do usuÃ¡rio ---

      at Object.log (auth.legacy.test.js:32:17)

  console.log
    âœ… UsuÃ¡rio da Empresa A carregado do setup.

      at Object.log (auth.legacy.test.js:35:17)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (auth.legacy.test.js:78:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (auth.legacy.test.js:91:17)

  console.log
    âœ… Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (auth.legacy.test.js:101:21)

  console.log
    
    --- Criando transaÃ§Ã£o para Empresa A ---

      at Object.log (isolamento.test.js:31:17)

  console.log
    Empresa A - Criar TransaÃ§Ã£o (Status): 201

      at Object.log (isolamento.test.js:44:17)

  console.log
    Empresa A - Criar TransaÃ§Ã£o (Corpo): {
      "companyId": "69134fff085bf85c08e41607",
      "userId": "69134fff085bf85c08e41609",
      "type": "expense",
      "description": "TransaÃ§Ã£o de Teste Empresa A",
      "amount": 100,
      "date": "2025-11-11T15:02:25.758Z",
      "paymentMethod": "other",
      "status": "pending",
      "_id": "6913500134a20d49f497eec9",
      "createdAt": "2025-11-11T15:02:25.779Z",
      "updatedAt": "2025-11-11T15:02:25.779Z",
      "__v": 0
    }

      at Object.log (isolamento.test.js:45:17)

  console.log
    Empresa A - ID da TransaÃ§Ã£o Criada: 6913500134a20d49f497eec9

      at Object.log (isolamento.test.js:49:17)

  console.log
    
    --- Tentando acessar transaÃ§Ã£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:52:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions/6913500134a20d49f497eec9 com token da Empresa B

      at Object.log (isolamento.test.js:53:17)

  console.log
    Empresa B - Acessar TransaÃ§Ã£o (Status): 404

      at Object.log (isolamento.test.js:61:21)

  console.log
    Empresa B - Acessar TransaÃ§Ã£o (Corpo): {
      "message": "Transaction nÃ£o encontrada"
    }

      at Object.log (isolamento.test.js:62:21)

  console.log
    
    --- Tentando modificar transaÃ§Ã£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:72:17)

  console.log
    Enviando: PUT para http://localhost:5000/api/transactions/6913500134a20d49f497eec9 com token da Empresa B

      at Object.log (isolamento.test.js:74:17)

  console.log
    Dados da atualizaÃ§Ã£o: {
      "description": "Tentativa de ModificaÃ§Ã£o pela Empresa B",
      "amount": 999
    }

      at Object.log (isolamento.test.js:75:17)

  console.log
    Empresa B - Modificar TransaÃ§Ã£o (Status): 404

      at Object.log (isolamento.test.js:83:21)

  console.log
    Empresa B - Modificar TransaÃ§Ã£o (Corpo): {
      "message": "Transaction nÃ£o encontrada"
    }

      at Object.log (isolamento.test.js:84:21)

  console.log
    
    --- Tentando excluir transaÃ§Ã£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:90:17)

  console.log
    Enviando: DELETE para http://localhost:5000/api/transactions/6913500134a20d49f497eec9 com token da Empresa B

      at Object.log (isolamento.test.js:91:17)

  console.log
    Empresa B - Excluir TransaÃ§Ã£o (Status): 404

      at Object.log (isolamento.test.js:99:21)

  console.log
    Empresa B - Excluir TransaÃ§Ã£o (Corpo): {
      "message": "Transaction nÃ£o encontrada"
    }

      at Object.log (isolamento.test.js:100:21)

  console.log
    
    --- Tentando listar transaÃ§Ãµes com token da Empresa B ---

      at Object.log (isolamento.test.js:108:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:109:17)

  console.log
    Empresa B - Listar TransaÃ§Ãµes (Status): 200

      at Object.log (isolamento.test.js:117:17)

  console.log
    Empresa B - Listar TransaÃ§Ãµes (Corpo): []

      at Object.log (isolamento.test.js:118:17)

  console.log
    Executando teste para: RF-009 - CRIAR Cliente (Pendente)

      at Object.log (clients.test.js:25:13)

  console.log
    âž¡ï¸  [PASS] Resposta da API: 201, Cliente criado com ID: 6913500234a20d49f497eedc

      at Object.log (clients.test.js:41:13)

  console.log
    Executando teste para: RF-009 - LISTAR Clientes (Pendente)

      at Object.log (clients.test.js:45:13)

  console.log
    âž¡ï¸  [PASS] Resposta da API: 200, 1 cliente(s) listado(s).

      at Object.log (clients.test.js:54:13)

  console.log
    
    --- Teste: Validar setup do usuÃ¡rio ---

      at Object.log (api.test.js:29:17)

  console.log
    âœ… UsuÃ¡rio da Empresa A carregado do setup.

      at Object.log (api.test.js:32:17)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (api.test.js:44:17)

  console.log
    âœ… E-mail duplicado barrado com sucesso (Status 409).

      at Object.log (api.test.js:55:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (api.test.js:64:17)

  console.log
    âœ… Login com senha incorreta falhou como esperado (Status 401).

      at Object.log (api.test.js:73:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (api.test.js:82:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (api.test.js:95:17)

  console.log
    âœ… Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (api.test.js:105:21)


--- ðŸ§¹ [TEARDOWN] Finalizando ambiente de testes e fechando conexÃ£o ---
--- âœ… ConexÃ£o com o banco de dados de teste fechada ---

--- FIM DOS TESTES AUTOMATIZADOS (COM FALHAS) ---
(node:3728) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 FAIL  Testes/auth.test.js
  6. MÃ³dulo de AutenticaÃ§Ã£o e SessÃ£o (Stateful)
    Ã— deve criar um SessionToken no banco de dados apÃ³s o login (159 ms)
    Ã— deve invalidar o SessionToken no banco de dados apÃ³s o logout (93 ms)

  â— 6. MÃ³dulo de AutenticaÃ§Ã£o e SessÃ£o (Stateful) â€º deve criar um SessionToken no banco de dados apÃ³s o login

    AxiosError: Request failed with status code 500

      32 |    */
      33 |   test('deve criar um SessionToken no banco de dados apÃ³s o login', async () => {
    > 34 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, {
         |                           ^
      35 |       email: userA.email,
      36 |       password: userA.password,
      37 |     });

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:34:27)

  â— 6. MÃ³dulo de AutenticaÃ§Ã£o e SessÃ£o (Stateful) â€º deve invalidar o SessionToken no banco de dados apÃ³s o logout

    AxiosError: Request failed with status code 500

      51 |   test('deve invalidar o SessionToken no banco de dados apÃ³s o logout', async () => {
      52 |     // 1. Realiza o login para obter um refresh token vÃ¡lido
    > 53 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, {
         |                           ^
      54 |       email: userA.email,
      55 |       password: userA.password,
      56 |     });

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:53:27)

 PASS  Testes/transactions.test.js
  4. MÃ³dulo de TransaÃ§Ãµes (CRUD)
    âˆš deve CRIAR uma nova transaÃ§Ã£o com sucesso (66 ms)
    âˆš deve falhar ao tentar criar uma transaÃ§Ã£o com dados invÃ¡lidos (31 ms)
    âˆš deve LISTAR as transaÃ§Ãµes do usuÃ¡rio logado (33 ms)
    âˆš deve OBTER uma transaÃ§Ã£o especÃ­fica pelo ID (31 ms)
    âˆš deve ATUALIZAR uma transaÃ§Ã£o existente (54 ms)
    âˆš deve EXCLUIR uma transaÃ§Ã£o existente (80 ms)

 FAIL  Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    Ã— deve criar uma transaÃ§Ã£o para cada empresa (1 ms)
    Ã— deve impedir que uma empresa acesse a transaÃ§Ã£o de outra
    Ã— deve garantir que cada empresa liste apenas suas prÃ³prias transaÃ§Ãµes

  â— 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) â€º deve criar uma transaÃ§Ã£o para cada empresa

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

  â— 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) â€º deve impedir que uma empresa acesse a transaÃ§Ã£o de outra

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

  â— 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) â€º deve garantir que cada empresa liste apenas suas prÃ³prias transaÃ§Ãµes

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

 FAIL  Testes/auth.legacy.test.js
  1. MÃ³dulo de AutenticaÃ§Ã£o (Legado)
    âˆš RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (4 ms)
    âˆš deve barrar o cadastro de um usuÃ¡rio com e-mail jÃ¡ existente (27 ms)
    âˆš deve falhar o login com senha incorreta (87 ms)
    Ã— deve realizar o login com sucesso para a Empresa A (94 ms)
    âˆš deve proteger rotas, barrando acesso sem token (5 ms)

  â— 1. MÃ³dulo de AutenticaÃ§Ã£o (Legado) â€º deve realizar o login com sucesso para a Empresa A

    AxiosError: Request failed with status code 500

      78 |         console.log('\n--- Teste: Login com sucesso ---');
      79 |
    > 80 |         const response = await axios.post(`${API_URL}/auth/login`, requestBody);
         |                          ^
      81 |
      82 |         // Espera-se que o login retorne status 200 (OK) e os tokens
      83 |         expect(response.status).toBe(200);

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.legacy.test.js:80:26)

 PASS  Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (TransaÃ§Ãµes)
    âˆš deve impedir o acesso, modificaÃ§Ã£o e exclusÃ£o de transaÃ§Ãµes entre empresas (163 ms)
    âˆš deve impedir que a Empresa B liste todas as transaÃ§Ãµes da Empresa A (30 ms)

 PASS  Testes/clients.test.js
  7. MÃ³dulo de Clientes/Fornecedores
    âˆš deve CRIAR um novo cliente com sucesso (49 ms)
    âˆš deve LISTAR os clientes da empresa (29 ms)

 PASS  Testes/isolamento.legacy.test.js
  2. Teste de Isolamento de Dados (TransaÃ§Ãµes)
    âˆš deve impedir o acesso, modificaÃ§Ã£o e exclusÃ£o de transaÃ§Ãµes entre empresas (140 ms)
    âˆš deve impedir que a Empresa B liste todas as transaÃ§Ãµes da Empresa A (28 ms)

 PASS  Testes/isolamento-simples.test.js
  2. Teste de Isolamento de Dados (Simples)
    âˆš deve impedir o acesso, modificaÃ§Ã£o e exclusÃ£o de transaÃ§Ãµes entre empresas (144 ms)
    âˆš deve impedir que a Empresa B liste todas as transaÃ§Ãµes da Empresa A (28 ms)

 FAIL  Testes/reports.test.js
  8. MÃ³dulo de RelatÃ³rios
    Ã— deve EXPORTAR um relatÃ³rio de transaÃ§Ãµes em formato PDF (35 ms)

  â— 8. MÃ³dulo de RelatÃ³rios â€º deve EXPORTAR um relatÃ³rio de transaÃ§Ãµes em formato PDF

    ReferenceError: __dirname is not defined

      34 |
      35 |     // Salva o PDF gerado para verificaÃ§Ã£o manual
    > 36 |     const pdfDir = path.join(__dirname, 'PDFs');
         |                              ^
      37 |     if (!fs.existsSync(pdfDir)) {
      38 |       fs.mkdirSync(pdfDir, { recursive: true });
      39 |     }

      at Object.__dirname (reports.test.js:36:30)

 FAIL  Testes/api.test.js
  1. MÃ³dulo de AutenticaÃ§Ã£o (Legado)
    âˆš RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    âˆš deve barrar o cadastro de um usuÃ¡rio com e-mail jÃ¡ existente (26 ms)
    âˆš deve falhar o login com senha incorreta (79 ms)
    Ã— deve realizar o login com sucesso para a Empresa A (79 ms)
    âˆš deve proteger rotas, barrando acesso sem token (5 ms)

  â— 1. MÃ³dulo de AutenticaÃ§Ã£o (Legado) â€º deve realizar o login com sucesso para a Empresa A

    AxiosError: Request failed with status code 500

      82 |         console.log('\n--- Teste: Login com sucesso ---');
      83 |
    > 84 |         const response = await axios.post(`${API_URL}/auth/login`, requestBody);
         |                          ^
      85 |
      86 |         // Espera-se que o login retorne status 200 (OK) e os tokens
      87 |         expect(response.status).toBe(200);

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (api.test.js:84:26)

 PASS  Testes/metas.test.js
  5. MÃ³dulo de Metas (CRUD)
    âˆš deve CRIAR uma nova meta com sucesso (54 ms)
    âˆš deve LISTAR as metas do usuÃ¡rio logado (31 ms)
    âˆš deve ATUALIZAR uma meta existente (58 ms)
    âˆš deve EXCLUIR uma meta existente (95 ms)

Test Suites: 5 failed, 6 passed, 11 total
Tests:       8 failed, 26 passed, 34 total
Snapshots:   0 total
Time:        4.056 s
Ran all test suites.
