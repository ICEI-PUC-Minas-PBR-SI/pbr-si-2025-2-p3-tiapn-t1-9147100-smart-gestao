  console.log
    
    --- Configurando 5 empresas para o teste multi-tenant ---

      at Object.log (Testes/multi-tenant.test.js:11:17)

(node:31936) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    ✅ Empresa 1 (Empresa Teste 1762393462160) cadastrada e logada.

      at Object.log (Testes/multi-tenant.test.js:39:21)

  console.log
    ✅ Empresa 2 (Empresa Teste 1762393462762) cadastrada e logada.

      at Object.log (Testes/multi-tenant.test.js:39:21)

  console.log
    ✅ Empresa 3 (Empresa Teste 1762393463102) cadastrada e logada.

      at Object.log (Testes/multi-tenant.test.js:39:21)

  console.log
    ✅ Empresa 4 (Empresa Teste 1762393463585) cadastrada e logada.

      at Object.log (Testes/multi-tenant.test.js:39:21)

  console.log
    ✅ Empresa 5 (Empresa Teste 1762393463974) cadastrada e logada.

      at Object.log (Testes/multi-tenant.test.js:39:21)

  console.log
    --- Configuração multi-tenant concluída ---

      at Object.log (Testes/multi-tenant.test.js:41:17)

  console.log
    
    --- Criando transações individuais para cada empresa ---

      at Object.log (Testes/multi-tenant.test.js:46:17)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.log (Testes/multi-tenant.test.js:71:17)

  console.log
    
    --- Validando listagem de transações ---

      at Object.log (Testes/multi-tenant.test.js:103:17)

FAIL Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    × deve criar uma transação para cada empresa (38 ms)
    × deve impedir que uma empresa acesse a transação de outra (1 ms)
    × deve garantir que cada empresa liste apenas suas próprias transações (55 ms)

  ● 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) › deve criar uma transação para cada empresa

    AxiosError: Request failed with status code 500

      54 |             };
      55 |
    > 56 |             const response = await axios.post(`${API_URL}/transactions`, transactionData, {
         |                              ^
      57 |                 headers: { Authorization: `Bearer ${company.token}` }
      58 |             });
      59 |

      at settle (node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (Testes/multi-tenant.test.js:56:30)

  ● 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) › deve impedir que uma empresa acesse a transação de outra

    TypeError: Cannot read properties of undefined (reading '_id')

      74 |         for (let i = 0; i < companies.length; i++) {
      75 |             const ownerCompany = companies[i]; // A dona da transação
    > 76 |             const transactionId = ownerCompany.transactions[0]._id;
         |                                                                ^
      77 |
      78 |             console.log(`\nVerificando a transação ${transactionId} da ${ownerCompany.companyName}`);
      79 |

      at Object._id (Testes/multi-tenant.test.js:76:64)

  ● 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) › deve garantir que cada empresa liste apenas suas próprias transações

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      110 |             expect(response.status).toBe(200);
      111 |             // A lista deve conter exatamente 1 transação
    > 112 |             expect(response.data).toHaveLength(1);
          |                                   ^
      113 |             // O ID da transação na lista deve ser o mesmo que criamos para essa empresa
      114 |             expect(response.data[0]._id).toBe(company.transactions[0]._id);
      115 |             console.log(`- OK: ${company.companyName} listou apenas sua própria transação.`);

      at Object.toHaveLength (Testes/multi-tenant.test.js:112:35)

  console.log
    
    --- Configurando Empresa A ---

      at Object.log (Testes/isolamento.test.js:42:17)

  console.log
    Empresa A configurada e logada.

      at Object.log (Testes/isolamento.test.js:55:17)

  console.log
    
    --- Configurando Empresa B ---

      at Object.log (Testes/isolamento.test.js:58:17)

  console.log
    Empresa B - Cadastro (Status): 201

      at Object.log (Testes/isolamento.test.js:67:17)

  console.log
    Empresa B - Cadastro (Corpo): {
      "message": "Usuário cadastrado com sucesso!"
    }

      at Object.log (Testes/isolamento.test.js:68:17)

  console.log
    Empresa B configurada e logada.

      at Object.log (Testes/isolamento.test.js:78:17)

  console.log
    
    --- Criando transação para Empresa A ---

      at Object.log (Testes/isolamento.test.js:84:17)

  console.log
    Empresa A - Criar Transação (Status): 201

      at Object.log (Testes/isolamento.test.js:97:17)

  console.log
    Empresa A - Criar Transação (Corpo): {
      "companyId": "690bfd7856f6a6ab875a1eab",
      "userId": "690bfd7856f6a6ab875a1eb1",
      "type": "expense",
      "description": "Transação de Teste Empresa A",
      "amount": 100,
      "date": "2025-11-06T01:44:25.311Z",
      "paymentMethod": "other",
      "status": "pending",
      "_id": "690bfd7956f6a6ab875a1ed4",
      "createdAt": "2025-11-06T01:44:25.337Z",
      "updatedAt": "2025-11-06T01:44:25.337Z",
      "__v": 0
    }

      at Object.log (Testes/isolamento.test.js:98:17)

  console.log
    Empresa A - ID da Transação Criada: 690bfd7956f6a6ab875a1ed4

      at Object.log (Testes/isolamento.test.js:102:17)

  console.log
    
    --- Tentando acessar transação da Empresa A com token da Empresa B ---

      at Object.log (Testes/isolamento.test.js:105:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions/690bfd7956f6a6ab875a1ed4 com token da Empresa B

      at Object.log (Testes/isolamento.test.js:106:17)

  console.log
    Empresa B - Acessar Transação (Status): 404

      at Object.log (Testes/isolamento.test.js:114:21)

  console.log
    Empresa B - Acessar Transação (Corpo): "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<title>Error</title>\n</head>\n<body>\n<pre>Cannot GET /api/transactions/690bfd7956f6a6ab875a1ed4</pre>\n</body>\n</html>\n"

      at Object.log (Testes/isolamento.test.js:115:21)

  console.log
    
    --- Tentando modificar transação da Empresa A com token da Empresa B ---

      at Object.log (Testes/isolamento.test.js:125:17)

  console.log
    Enviando: PUT para http://localhost:5000/api/transactions/690bfd7956f6a6ab875a1ed4 com token da Empresa B

      at Object.log (Testes/isolamento.test.js:127:17)

  console.log
    Dados da atualização: {
      "description": "Tentativa de Modificação pela Empresa B",
      "amount": 999
    }

      at Object.log (Testes/isolamento.test.js:128:17)

  console.log
    Empresa B - Modificar Transação (Status): 404

      at Object.log (Testes/isolamento.test.js:136:21)

  console.log
    Empresa B - Modificar Transação (Corpo): {
      "message": "Transaction não encontrada"
    }

      at Object.log (Testes/isolamento.test.js:137:21)

  console.log
    
    --- Tentando excluir transação da Empresa A com token da Empresa B ---

      at Object.log (Testes/isolamento.test.js:143:17)

  console.log
    Enviando: DELETE para http://localhost:5000/api/transactions/690bfd7956f6a6ab875a1ed4 com token da Empresa B

      at Object.log (Testes/isolamento.test.js:144:17)

  console.log
    Empresa B - Excluir Transação (Status): 404

      at Object.log (Testes/isolamento.test.js:152:21)

  console.log
    Empresa B - Excluir Transação (Corpo): {
      "message": "Transaction não encontrada"
    }

      at Object.log (Testes/isolamento.test.js:153:21)

  console.log
    
    --- Tentando listar transações com token da Empresa B ---

      at Object.log (Testes/isolamento.test.js:161:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (Testes/isolamento.test.js:162:17)

  console.log
    Empresa B - Listar Transações (Status): 200

      at Object.log (Testes/isolamento.test.js:170:17)

  console.log
    Empresa B - Listar Transações (Corpo): []

      at Object.log (Testes/isolamento.test.js:171:17)

PASS Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transações)
    √ deve impedir o acesso, modificação e exclusão de transações entre empresas (358 ms)
    √ deve impedir que a Empresa B liste todas as transações da Empresa A (58 ms)

  console.log
    
    --- Teste: Cadastrar novo usuário ---

      at Object.log (Testes/api.test.js:50:17)

  console.log
    Enviando: {
      "name": "Usuário A",
      "email": "empresaA_1762393465856@test.com",
      "password": "password123",
      "companyName": "Empresa A Teste 1762393465856",
      "cnpj": "01762393465856"
    }

      at Object.log (Testes/api.test.js:51:17)

  console.log
    Recebido (Status): 201

      at Object.log (Testes/api.test.js:56:21)

  console.log
    Recebido (Corpo): {
      "message": "Usuário cadastrado com sucesso!"
    }

      at Object.log (Testes/api.test.js:57:21)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (Testes/api.test.js:79:17)

  console.log
    Enviando: {
      "name": "Usuário A",
      "email": "empresaA_1762393465856@test.com",
      "password": "password123",
      "companyName": "Nome Duplicado",
      "cnpj": "11223344556677"
    }

      at Object.log (Testes/api.test.js:80:17)

  console.log
    Recebido (Status): 409

      at Object.log (Testes/api.test.js:86:21)

  console.log
    Recebido (Corpo): {
      "message": "E-mail já cadastrado."
    }

      at Object.log (Testes/api.test.js:87:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (Testes/api.test.js:101:17)

  console.log
    Enviando: {
      "email": "empresaA_1762393465856@test.com",
      "password": "senha-errada"
    }

      at Object.log (Testes/api.test.js:102:17)

  console.log
    Recebido (Status): 401

      at Object.log (Testes/api.test.js:107:21)

  console.log
    Recebido (Corpo): {
      "message": "Credenciais inválidas."
    }

      at Object.log (Testes/api.test.js:108:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (Testes/api.test.js:122:17)

  console.log
    Enviando: {
      "email": "empresaA_1762393465856@test.com",
      "password": "password123"
    }

      at Object.log (Testes/api.test.js:123:17)

  console.log
    Recebido (Status): 200

      at Object.log (Testes/api.test.js:127:17)

  console.log
    Recebido (Corpo): {
      "user": {
        "name": "Usuário A",
        "email": "empresaa_1762393465856@test.com"
      },
      "message": "Tokens recebidos"
    }

      at Object.log (Testes/api.test.js:128:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (Testes/api.test.js:141:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions

      at Object.log (Testes/api.test.js:142:17)

  console.log
    Recebido (Status): 401

      at Object.log (Testes/api.test.js:148:21)

  console.log
    Recebido (Corpo): {
      "message": "Token ausente ou formato inválido"
    }

      at Object.log (Testes/api.test.js:149:21)

PASS Testes/api.test.js
  1. Módulo de Autenticação
    √ RF-001: deve cadastrar um novo usuário e empresa (Empresa A) (174 ms)
    √ deve barrar o cadastro de um usuário com e-mail já existente (41 ms)
    √ deve falhar o login com senha incorreta (151 ms)
    √ deve realizar o login com sucesso para a Empresa A (86 ms)
    √ deve proteger rotas, barrando acesso sem token (5 ms)

----------|---------|----------|---------|---------|-------------------
File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------|---------|----------|---------|---------|-------------------
All files |       0 |        0 |       0 |       0 |                   
----------|---------|----------|---------|---------|-------------------
Test Suites: 1 failed, 2 passed, 3 total
Tests:       3 failed, 7 passed, 10 total
Snapshots:   0 total
Time:        4.693 s
Ran all test suites.
