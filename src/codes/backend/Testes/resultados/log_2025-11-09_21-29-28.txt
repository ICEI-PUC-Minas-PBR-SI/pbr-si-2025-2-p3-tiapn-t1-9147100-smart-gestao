
--- üöÄ Iniciando Setup Global de Testes ---
‚úÖ Empresa Padr√£o 1 criada para os testes.
‚úÖ Empresa Padr√£o 2 criada para os testes.
--- ‚úÖ Setup Global Conclu√≠do. Dados salvos em Testes\test-setup.json ---

  console.log
    
    --- Criando transa√ß√£o para Empresa A ---

      at Object.log (isolamento.test.js:27:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Status): 201

      at Object.log (isolamento.test.js:40:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Corpo): {
      "companyId": "691131e9ce9dde2578895bac",
      "userId": "691131e9ce9dde2578895bae",
      "type": "expense",
      "description": "Transa√ß√£o de Teste Empresa A",
      "amount": 100,
      "date": "2025-11-10T00:29:31.041Z",
      "paymentMethod": "other",
      "status": "pending",
      "_id": "691131ebce9dde2578895be3",
      "createdAt": "2025-11-10T00:29:31.074Z",
      "updatedAt": "2025-11-10T00:29:31.074Z",
      "__v": 0
    }

      at Object.log (isolamento.test.js:41:17)

  console.log
    Empresa A - ID da Transa√ß√£o Criada: 691131ebce9dde2578895be3

      at Object.log (isolamento.test.js:45:17)

  console.log
    
    --- Tentando acessar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:48:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions/691131ebce9dde2578895be3 com token da Empresa B

      at Object.log (isolamento.test.js:49:17)

  console.log
    Empresa B - Acessar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:57:21)

  console.log
    Empresa B - Acessar Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:58:21)

  console.log
    
    --- Tentando modificar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:68:17)

  console.log
    Enviando: PUT para http://localhost:5000/api/transactions/691131ebce9dde2578895be3 com token da Empresa B

      at Object.log (isolamento.test.js:70:17)

  console.log
    Dados da atualiza√ß√£o: {
      "description": "Tentativa de Modifica√ß√£o pela Empresa B",
      "amount": 999
    }

      at Object.log (isolamento.test.js:71:17)

  console.log
    Empresa B - Modificar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:79:21)

  console.log
    Empresa B - Modificar Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:80:21)

  console.log
    
    --- Tentando excluir transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:86:17)

  console.log
    Enviando: DELETE para http://localhost:5000/api/transactions/691131ebce9dde2578895be3 com token da Empresa B

      at Object.log (isolamento.test.js:87:17)

  console.log
    Empresa B - Excluir Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:95:21)

  console.log
    Empresa B - Excluir Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:96:21)

  console.log
    
    --- Tentando listar transa√ß√µes com token da Empresa B ---

      at Object.log (isolamento.test.js:104:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:105:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Status): 200

      at Object.log (isolamento.test.js:113:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Corpo): []

      at Object.log (isolamento.test.js:114:17)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (api.test.js:28:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (api.test.js:31:17)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (api.test.js:43:17)

  console.log
    ‚úÖ E-mail duplicado barrado com sucesso (Status 409).

      at Object.log (api.test.js:54:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (api.test.js:63:17)

  console.log
    ‚úÖ Login com senha incorreta falhou como esperado (Status 401).

      at Object.log (api.test.js:72:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (api.test.js:81:17)

  console.log
    ‚úÖ Login realizado com sucesso.

      at Object.log (api.test.js:90:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (api.test.js:94:17)

  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:12:17)

  console.log
    ‚úÖ Empresa 1 (Empresa Teste 1762734571945) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    ‚úÖ Empresa 2 (Empresa Teste 1762734572248) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    ‚úÖ Empresa 3 (Empresa Teste 1762734572553) cadastrada e logada.

      at Object.log (multi-tenant.test.js:41:21)

  console.log
    --- Configura√ß√£o multi-tenant conclu√≠da ---

      at Object.log (multi-tenant.test.js:43:17)

  console.log
    
    --- Criando transa√ß√µes individuais para cada empresa ---

      at Object.log (multi-tenant.test.js:48:17)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762734571945. ID: 691131ecce9dde2578895c2b

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762734572248. ID: 691131edce9dde2578895c32

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762734572553. ID: 691131edce9dde2578895c39

      at Object.log (multi-tenant.test.js:69:21)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.log (multi-tenant.test.js:75:17)

  console.log
    
    Verificando a transa√ß√£o 691131ecce9dde2578895c2b da Empresa Teste 1762734571945

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762734572248 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762734572553 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    Verificando a transa√ß√£o 691131edce9dde2578895c32 da Empresa Teste 1762734572248

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762734571945 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762734572553 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    Verificando a transa√ß√£o 691131edce9dde2578895c39 da Empresa Teste 1762734572553

      at Object.log (multi-tenant.test.js:82:21)

  console.log
    - OK: Empresa Teste 1762734571945 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    - OK: Empresa Teste 1762734572248 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:100:29)

  console.log
    
    --- Validando listagem de transa√ß√µes ---

      at Object.log (multi-tenant.test.js:107:17)

  console.log
    - OK: Empresa Teste 1762734571945 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    - OK: Empresa Teste 1762734572248 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    - OK: Empresa Teste 1762734572553 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:119:21)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:125:17)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762734571945 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762734572248 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762734572553 exclu√≠da com sucesso.

      at Object.log (multi-tenant.test.js:133:33)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (auth.legacy.test.js:28:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (auth.legacy.test.js:31:17)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (auth.legacy.test.js:74:17)

  console.log
    ‚úÖ Login realizado com sucesso.

      at Object.log (auth.legacy.test.js:83:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (auth.legacy.test.js:87:17)

  console.log
    Executando teste para: RF-009 - CRIAR Cliente (Pendente)

      at Object.log (clients.test.js:26:13)

  console.log
    Executando teste para: RF-009 - LISTAR Clientes (Pendente)

      at Object.log (clients.test.js:46:13)

  console.log
    Executando teste para: RF-008 - Exportar PDF (Pendente)

      at Object.log (reports.test.js:23:13)


--- FIM DOS TESTES AUTOMATIZADOS (COM FALHAS) ---
(node:24440) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  Testes/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    ‚àö deve CRIAR uma nova transa√ß√£o com sucesso (105 ms)
    ‚àö deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (37 ms)
    ‚àö deve LISTAR as transa√ß√µes do usu√°rio logado (85 ms)
    ‚àö deve OBTER uma transa√ß√£o espec√≠fica pelo ID (46 ms)
    ‚àö deve ATUALIZAR uma transa√ß√£o existente (79 ms)
    ‚àö deve EXCLUIR uma transa√ß√£o existente (114 ms)

 PASS  Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (314 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (54 ms)

 FAIL  Testes/api.test.js
  1. M√≥dulo de Autentica√ß√£o
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (6 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (36 ms)
    ‚àö deve falhar o login com senha incorreta (114 ms)
    ‚àö deve realizar o login com sucesso para a Empresa A (124 ms)
    √ó deve proteger rotas, barrando acesso sem token (17 ms)

  ‚óè 1. M√≥dulo de Autentica√ß√£o ‚Ä∫ deve proteger rotas, barrando acesso sem token

    expect(received).toBe(expected) // Object.is equality

    Expected: "Token ausente ou formato inv√°lido"
    Received: "Acesso negado. Token de autentica√ß√£o n√£o fornecido ou em formato inv√°lido."

      101 |             // O middleware de autentica√ß√£o deve retornar 401 (Unauthorized)
      102 |             expect(error.response.status).toBe(401);
    > 103 |             expect(error.response.data.message).toBe('Token ausente ou formato inv√°lido');
          |                                                 ^
      104 |             console.log('‚úÖ Acesso sem token foi barrado como esperado (Status 401).');
      105 |         }
      106 |     });

      at Object.toBe (api.test.js:103:49)

 PASS  Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    ‚àö deve criar uma transa√ß√£o para cada empresa (236 ms)
    ‚àö deve impedir que uma empresa acesse a transa√ß√£o de outra (300 ms)
    ‚àö deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes (141 ms)

 PASS  Testes/isolamento.legacy.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (286 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (40 ms)

 PASS  Testes/isolamento-simples.test.js
  2. Teste de Isolamento de Dados (Simples)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (241 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (58 ms)

 FAIL  Testes/auth.test.js (20.501 s)
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    √ó deve criar um SessionToken no banco de dados ap√≥s o login (10010 ms)
    √ó deve invalidar o SessionToken no banco de dados ap√≥s o logout (10015 ms)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve criar um SessionToken no banco de dados ap√≥s o login

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (../node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:185:23)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve invalidar o SessionToken no banco de dados ap√≥s o logout

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (../node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:185:23)

 FAIL  Testes/auth.legacy.test.js
  1. M√≥dulo de Autentica√ß√£o
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (38 ms)
    ‚àö deve falhar o login com senha incorreta (100 ms)
    ‚àö deve realizar o login com sucesso para a Empresa A (120 ms)
    √ó deve proteger rotas, barrando acesso sem token (9 ms)

  ‚óè 1. M√≥dulo de Autentica√ß√£o ‚Ä∫ deve proteger rotas, barrando acesso sem token

    expect(received).toBe(expected) // Object.is equality

    Expected: "Token ausente ou formato inv√°lido"
    Received: "Acesso negado. Token de autentica√ß√£o n√£o fornecido ou em formato inv√°lido."

      94 |             // O middleware de autentica√ß√£o deve retornar 401 (Unauthorized)
      95 |             expect(error.response.status).toBe(401);
    > 96 |             expect(error.response.data.message).toBe('Token ausente ou formato inv√°lido');
         |                                                 ^
      97 |             console.log('‚úÖ Acesso sem token foi barrado como esperado (Status 401).');
      98 |         }
      99 |     });

      at Object.toBe (auth.legacy.test.js:96:49)

 PASS  Testes/metas.test.js
  5. M√≥dulo de Metas (CRUD)
    ‚àö deve CRIAR uma nova meta com sucesso (83 ms)
    ‚àö deve LISTAR as metas do usu√°rio logado (38 ms)
    ‚àö deve ATUALIZAR uma meta existente (74 ms)
    ‚àö deve EXCLUIR uma meta existente (153 ms)

 FAIL  Testes/clients.test.js
  7. M√≥dulo de Clientes/Fornecedores (TDD)
    √ó deve CRIAR um novo cliente com sucesso (4 ms)
    √ó deve LISTAR os clientes da empresa (1 ms)

  ‚óè 7. M√≥dulo de Clientes/Fornecedores (TDD) ‚Ä∫ deve CRIAR um novo cliente com sucesso

    TypeError: Invalid URL

      32 |     };
      33 |
    > 34 |     const response = await axios.post(`${API_URL}/clients`, newClient, {
         |                                  ^
      35 |       headers: { Authorization: `Bearer ${companyA.token}` },
      36 |     });
      37 |

      at dispatchHttpRequest (../node_modules/axios/lib/adapters/http.js:408:20)
      at ../node_modules/axios/lib/adapters/http.js:249:5
      at wrapAsync (../node_modules/axios/lib/adapters/http.js:229:10)
      at http (../node_modules/axios/lib/adapters/http.js:314:10)
      at Axios.dispatchRequest (../node_modules/axios/lib/core/dispatchRequest.js:51:10)
      at Axios._request (../node_modules/axios/lib/core/Axios.js:185:33)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:40:25)
      at Axios.httpMethod [as post] (../node_modules/axios/lib/core/Axios.js:224:19)
      at wrap (../node_modules/axios/lib/helpers/bind.js:12:15)
      at Object.post (clients.test.js:34:34)

  ‚óè 7. M√≥dulo de Clientes/Fornecedores (TDD) ‚Ä∫ deve LISTAR os clientes da empresa

    TypeError: Invalid URL

      45 |   test('deve LISTAR os clientes da empresa', async () => {
      46 |     console.log('Executando teste para: RF-009 - LISTAR Clientes (Pendente)');
    > 47 |     const response = await axios.get(`${API_URL}/clients`, {
         |                                  ^
      48 |       headers: { Authorization: `Bearer ${companyA.token}` },
      49 |     });
      50 |

      at dispatchHttpRequest (../node_modules/axios/lib/adapters/http.js:408:20)
      at ../node_modules/axios/lib/adapters/http.js:249:5
      at wrapAsync (../node_modules/axios/lib/adapters/http.js:229:10)
      at http (../node_modules/axios/lib/adapters/http.js:314:10)
      at Axios.dispatchRequest (../node_modules/axios/lib/core/dispatchRequest.js:51:10)
      at Axios._request (../node_modules/axios/lib/core/Axios.js:185:33)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:40:25)
      at Axios.<computed> [as get] (../node_modules/axios/lib/core/Axios.js:211:17)
      at wrap [as get] (../node_modules/axios/lib/helpers/bind.js:12:15)
      at Object.get (clients.test.js:47:34)

 FAIL  Testes/reports.test.js
  8. M√≥dulo de Relat√≥rios (TDD)
    √ó deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF (3 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios (TDD) ‚Ä∫ deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF

    ReferenceError: jest is not defined

      24 |     
      25 |     // Aumenta o timeout para este teste, pois a gera√ß√£o de PDF pode ser mais lenta.
    > 26 |     jest.setTimeout(20000);
         |     ^
      27 |
      28 |     const response = await axios.get(`${API_URL}/reports/export/pdf`, {
      29 |       headers: { Authorization: `Bearer ${companyA.token}` },

      at Object.jest (reports.test.js:26:5)

Test Suites: 5 failed, 6 passed, 11 total
Tests:       7 failed, 27 passed, 34 total
Snapshots:   0 total
Time:        26.819 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
