
--- üöÄ [SETUP] Conectando e populando o banco de dados de DESENVOLVIMENTO para os testes ---
‚úÖ Empresa Padr√£o 1 criada para os testes.
‚úÖ Empresa Padr√£o 2 criada para os testes.
--- ‚úÖ [SETUP] Dados de teste salvos em test-setup.json ---
  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (auth.legacy.test.js:32:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (auth.legacy.test.js:35:17)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (auth.legacy.test.js:78:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (auth.legacy.test.js:91:17)

  console.log
    ‚úÖ Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (auth.legacy.test.js:101:21)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (api.test.js:29:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (api.test.js:32:17)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (api.test.js:44:17)

  console.log
    ‚úÖ E-mail duplicado barrado com sucesso (Status 409).

      at Object.log (api.test.js:55:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (api.test.js:64:17)

  console.log
    ‚úÖ Login com senha incorreta falhou como esperado (Status 401).

      at Object.log (api.test.js:73:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (api.test.js:82:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (api.test.js:95:17)

  console.log
    ‚úÖ Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (api.test.js:105:21)

  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:16:17)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:129:17)

  console.log
    
    --- Criando transa√ß√£o para Empresa A ---

      at Object.log (isolamento.test.js:31:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Status): 201

      at Object.log (isolamento.test.js:44:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Corpo): {
      "companyId": "69136da02634781c20c9c17f",
      "userId": "69136da02634781c20c9c181",
      "type": "expense",
      "description": "Transa√ß√£o de Teste Empresa A",
      "amount": 100,
      "date": "2025-11-11T17:08:52.474Z",
      "paymentMethod": "other",
      "status": "pending",
      "_id": "69136da4f3e829970f64d27c",
      "createdAt": "2025-11-11T17:08:52.499Z",
      "updatedAt": "2025-11-11T17:08:52.499Z",
      "__v": 0
    }

      at Object.log (isolamento.test.js:45:17)

  console.log
    Empresa A - ID da Transa√ß√£o Criada: 69136da4f3e829970f64d27c

      at Object.log (isolamento.test.js:49:17)

  console.log
    
    --- Tentando acessar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:52:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions/69136da4f3e829970f64d27c com token da Empresa B

      at Object.log (isolamento.test.js:53:17)

  console.log
    Empresa B - Acessar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:61:21)

  console.log
    Empresa B - Acessar Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:62:21)

  console.log
    
    --- Tentando modificar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:72:17)

  console.log
    Enviando: PUT para http://localhost:5000/api/transactions/69136da4f3e829970f64d27c com token da Empresa B

      at Object.log (isolamento.test.js:74:17)

  console.log
    Dados da atualiza√ß√£o: {
      "description": "Tentativa de Modifica√ß√£o pela Empresa B",
      "amount": 999
    }

      at Object.log (isolamento.test.js:75:17)

  console.log
    Empresa B - Modificar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:83:21)

  console.log
    Empresa B - Modificar Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:84:21)

  console.log
    
    --- Tentando excluir transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:90:17)

  console.log
    Enviando: DELETE para http://localhost:5000/api/transactions/69136da4f3e829970f64d27c com token da Empresa B

      at Object.log (isolamento.test.js:91:17)

  console.log
    Empresa B - Excluir Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:99:21)

  console.log
    Empresa B - Excluir Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:100:21)

  console.log
    
    --- Tentando listar transa√ß√µes com token da Empresa B ---

      at Object.log (isolamento.test.js:108:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:109:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Status): 200

      at Object.log (isolamento.test.js:117:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Corpo): []

      at Object.log (isolamento.test.js:118:17)

  console.log
    Executando teste para: RF-009 - CRIAR Cliente (Pendente)

      at Object.log (clients.test.js:26:13)

  console.log
    ‚û°Ô∏è  [PASS] Resposta da API: 201, Cliente criado com ID: 69136da5f3e829970f64d2a2

      at Object.log (clients.test.js:42:13)

  console.log
    Executando teste para: RF-009 - LISTAR Clientes (Pendente)

      at Object.log (clients.test.js:46:13)

  console.log
    ‚û°Ô∏è  [PASS] Resposta da API: 200, 1 cliente(s) listado(s).

      at Object.log (clients.test.js:55:13)


--- üßπ [TEARDOWN] Finalizando ambiente de testes e fechando conex√£o ---
--- ‚úÖ Conex√£o com o banco de dados de teste fechada ---

--- FIM DOS TESTES AUTOMATIZADOS (COM FALHAS) ---
(node:7536) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 FAIL  Testes/auth.test.js
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    √ó deve criar um SessionToken no banco de dados ap√≥s o login (131 ms)
    √ó deve invalidar o SessionToken no banco de dados ap√≥s o logout (81 ms)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve criar um SessionToken no banco de dados ap√≥s o login

    AxiosError: Request failed with status code 500

      32 |    */
      33 |   test('deve criar um SessionToken no banco de dados ap√≥s o login', async () => {
    > 34 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, {
         |                           ^
      35 |       email: userA.email,
      36 |       password: userA.password,
      37 |     });

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:34:27)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve invalidar o SessionToken no banco de dados ap√≥s o logout

    AxiosError: Request failed with status code 500

      51 |   test('deve invalidar o SessionToken no banco de dados ap√≥s o logout', async () => {
      52 |     // 1. Realiza o login para obter um refresh token v√°lido
    > 53 |     const loginResponse = await axios.post(`${API_URL}/auth/login`, {
         |                           ^
      54 |       email: userA.email,
      55 |       password: userA.password,
      56 |     });

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.test.js:53:27)

 FAIL  Testes/auth.legacy.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (15 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (28 ms)
    ‚àö deve falhar o login com senha incorreta (79 ms)
    √ó deve realizar o login com sucesso para a Empresa A (81 ms)
    ‚àö deve proteger rotas, barrando acesso sem token (6 ms)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve realizar o login com sucesso para a Empresa A

    AxiosError: Request failed with status code 500

      78 |         console.log('\n--- Teste: Login com sucesso ---');
      79 |
    > 80 |         const response = await axios.post(`${API_URL}/auth/login`, requestBody);
         |                          ^
      81 |
      82 |         // Espera-se que o login retorne status 200 (OK) e os tokens
      83 |         expect(response.status).toBe(200);

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (auth.legacy.test.js:80:26)

 FAIL  Testes/api.test.js
  1. M√≥dulo de Autentica√ß√£o (Legado)
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (5 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (28 ms)
    ‚àö deve falhar o login com senha incorreta (81 ms)
    √ó deve realizar o login com sucesso para a Empresa A (82 ms)
    ‚àö deve proteger rotas, barrando acesso sem token (4 ms)

  ‚óè 1. M√≥dulo de Autentica√ß√£o (Legado) ‚Ä∫ deve realizar o login com sucesso para a Empresa A

    AxiosError: Request failed with status code 500

      82 |         console.log('\n--- Teste: Login com sucesso ---');
      83 |
    > 84 |         const response = await axios.post(`${API_URL}/auth/login`, requestBody);
         |                          ^
      85 |
      86 |         // Espera-se que o login retorne status 200 (OK) e os tokens
      87 |         expect(response.status).toBe(200);

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (api.test.js:84:26)

 FAIL  Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    √ó deve criar uma transa√ß√£o para cada empresa (1 ms)
    √ó deve impedir que uma empresa acesse a transa√ß√£o de outra
    √ó deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes

  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve criar uma transa√ß√£o para cada empresa

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve impedir que uma empresa acesse a transa√ß√£o de outra

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

  ‚óè 3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant) ‚Ä∫ deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes

    AxiosError: Request failed with status code 500

      27 |
      28 |             // Cadastrar
    > 29 |             const registerResponse = await axios.post(`${API_URL}/auth/register`, companyData);
         |                                      ^
      30 |
      31 |             // Logar para obter o token
      32 |             const loginResponse = await axios.post(`${API_URL}/auth/login`, {

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (multi-tenant.test.js:29:38)

 FAIL  Testes/reports.test.js
  8. M√≥dulo de Relat√≥rios
    √ó deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF (88 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios ‚Ä∫ deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF

    ReferenceError: __dirname is not defined

      35 |
      36 |     // Salva o PDF gerado para verifica√ß√£o manual
    > 37 |     const pdfDir = path.join(__dirname, 'PDFs');
         |                              ^
      38 |     if (!fs.existsSync(pdfDir)) {
      39 |       fs.mkdirSync(pdfDir, { recursive: true });
      40 |     }

      at Object.__dirname (reports.test.js:37:30)

 PASS  Testes/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    ‚àö deve CRIAR uma nova transa√ß√£o com sucesso (60 ms)
    ‚àö deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (23 ms)
    ‚àö deve LISTAR as transa√ß√µes do usu√°rio logado (28 ms)
    ‚àö deve OBTER uma transa√ß√£o espec√≠fica pelo ID (29 ms)
    ‚àö deve ATUALIZAR uma transa√ß√£o existente (67 ms)
    ‚àö deve EXCLUIR uma transa√ß√£o existente (88 ms)

 PASS  Testes/metas.test.js
  5. M√≥dulo de Metas (CRUD)
    ‚àö deve CRIAR uma nova meta com sucesso (57 ms)
    ‚àö deve LISTAR as metas do usu√°rio logado (29 ms)
    ‚àö deve ATUALIZAR uma meta existente (50 ms)
    ‚àö deve EXCLUIR uma meta existente (81 ms)

 PASS  Testes/isolamento-simples.test.js
  2. Teste de Isolamento de Dados (Simples)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (169 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (28 ms)

 PASS  Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (168 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (32 ms)

 PASS  Testes/isolamento.legacy.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (153 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (27 ms)

 PASS  Testes/clients.test.js
  7. M√≥dulo de Clientes/Fornecedores
    ‚àö deve CRIAR um novo cliente com sucesso (160 ms)
    ‚àö deve LISTAR os clientes da empresa (30 ms)

Test Suites: 5 failed, 6 passed, 11 total
Tests:       8 failed, 26 passed, 34 total
Snapshots:   0 total
Time:        4.354 s, estimated 25 s
Ran all test suites.
