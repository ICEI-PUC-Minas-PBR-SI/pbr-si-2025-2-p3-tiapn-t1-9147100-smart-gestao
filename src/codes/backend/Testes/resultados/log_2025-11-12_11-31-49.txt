
--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.
(node:22848) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/1-auth/password.test.js (31.402 s)
  9. M√≥dulo de Recupera√ß√£o de Senha
    √ó deve falhar ao solicitar reset para um e-mail inexistente (10022 ms)
    √ó deve gerar e salvar um token de reset para um e-mail v√°lido (10004 ms)
    √ó deve resetar a senha com um token v√°lido e permitir login com a nova senha (10001 ms)

  ‚óè 9. M√≥dulo de Recupera√ß√£o de Senha ‚Ä∫ deve falhar ao solicitar reset para um e-mail inexistente

    MongooseError: Operation `users.updateOne()` buffering timed out after 10000ms

      at Timeout.<anonymous> (node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:187:23)

  ‚óè 9. M√≥dulo de Recupera√ß√£o de Senha ‚Ä∫ deve gerar e salvar um token de reset para um e-mail v√°lido

    MongooseError: Operation `users.updateOne()` buffering timed out after 10000ms

      at Timeout.<anonymous> (node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:187:23)

  ‚óè 9. M√≥dulo de Recupera√ß√£o de Senha ‚Ä∫ deve resetar a senha com um token v√°lido e permitir login com a nova senha

    MongooseError: Operation `users.updateOne()` buffering timed out after 10000ms

      at Timeout.<anonymous> (node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:187:23)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/1-auth/auth.test.js (20.942 s)
  6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful)
    √ó deve criar um SessionToken no banco de dados ap√≥s o login (10020 ms)
    √ó deve invalidar o SessionToken no banco de dados ap√≥s o logout (10013 ms)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve criar um SessionToken no banco de dados ap√≥s o login

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:187:23)

  ‚óè 6. M√≥dulo de Autentica√ß√£o e Sess√£o (Stateful) ‚Ä∫ deve invalidar o SessionToken no banco de dados ap√≥s o logout

    MongooseError: Operation `sessiontokens.deleteMany()` buffering timed out after 10000ms

      at Timeout.<anonymous> (node_modules/mongoose/lib/drivers/node-mongodb-native/collection.js:187:23)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/2-features/goals.test.js
  5. M√≥dulo de Metas (CRUD)
    √ó deve CRIAR uma nova meta com sucesso (114 ms)
    √ó deve LISTAR as metas do usu√°rio logado
    √ó deve ATUALIZAR uma meta existente (1 ms)
    √ó deve EXCLUIR uma meta existente (1 ms)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve CRIAR uma nova meta com sucesso

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 200

      30 |         });
      31 |
    > 32 |         expect(response.status).toBe(201);
         |                                 ^
      33 |         expect(response.data.data).toHaveProperty('_id');
      34 |         expect(response.data.data.title).toBe(goalData.title);
      35 |         expect(response.data.data.targetAmount).toBe(goalData.targetAmount);

      at Object.<anonymous> (Testes/2-features/goals.test.js:32:33)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve LISTAR as metas do usu√°rio logado

    expect(received).toBeDefined()

    Received: undefined

      39 |
      40 |     it('deve LISTAR as metas do usu√°rio logado', async () => {
    > 41 |         expect(createdGoalId).toBeDefined();
         |                               ^
      42 |
      43 |         const response = await axios.get(`${API_URL}/goals`, {
      44 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.<anonymous> (Testes/2-features/goals.test.js:41:31)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve ATUALIZAR uma meta existente

    expect(received).toBeDefined()

    Received: undefined

      52 |
      53 |     it('deve ATUALIZAR uma meta existente', async () => {
    > 54 |         expect(createdGoalId).toBeDefined();
         |                               ^
      55 |
      56 |         const updatedData = {
      57 |             title: 'Economizar para novo maquin√°rio (URGENTE)',

      at Object.<anonymous> (Testes/2-features/goals.test.js:54:31)

  ‚óè 5. M√≥dulo de Metas (CRUD) ‚Ä∫ deve EXCLUIR uma meta existente

    expect(received).toBeDefined()

    Received: undefined

      69 |
      70 |     it('deve EXCLUIR uma meta existente', async () => {
    > 71 |         expect(createdGoalId).toBeDefined();
         |                               ^
      72 |
      73 |         const response = await axios.delete(`${API_URL}/goals/${createdGoalId}`, {
      74 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.<anonymous> (Testes/2-features/goals.test.js:71:31)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.
  console.log
    
    --- Configurando 3 empresas para o teste multi-tenant ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:19:17)

  console.log
    ‚úÖ Empresa 1 (Empresa Teste 1762957965204) cadastrada e logada.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:48:21)

  console.log
    ‚úÖ Empresa 2 (Empresa Teste 1762957965488) cadastrada e logada.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:48:21)

  console.log
    ‚úÖ Empresa 3 (Empresa Teste 1762957965735) cadastrada e logada.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:48:21)

  console.log
    --- Configura√ß√£o multi-tenant conclu√≠da ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:50:17)

  console.log
    
    --- Criando transa√ß√µes individuais para cada empresa ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:55:17)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762957965204. ID: 69149a8ed7cfb01b3aeb901e

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:76:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762957965488. ID: 69149a8ed7cfb01b3aeb9025

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:76:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762957965735. ID: 69149a8ed7cfb01b3aeb902c

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:76:21)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:82:17)

  console.log
    
    Verificando a transa√ß√£o 69149a8ed7cfb01b3aeb901e da Empresa Teste 1762957965204

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:89:21)

  console.log
    - OK: Empresa Teste 1762957965488 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    - OK: Empresa Teste 1762957965735 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    Verificando a transa√ß√£o 69149a8ed7cfb01b3aeb9025 da Empresa Teste 1762957965488

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:89:21)

  console.log
    - OK: Empresa Teste 1762957965204 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    - OK: Empresa Teste 1762957965735 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    Verificando a transa√ß√£o 69149a8ed7cfb01b3aeb902c da Empresa Teste 1762957965735

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:89:21)

  console.log
    - OK: Empresa Teste 1762957965204 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    - OK: Empresa Teste 1762957965488 foi bloqueada (Status 404).

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:107:29)

  console.log
    
    --- Validando listagem de transa√ß√µes ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:114:17)

  console.log
    - OK: Empresa Teste 1762957965204 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:126:21)

  console.log
    - OK: Empresa Teste 1762957965488 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:126:21)

  console.log
    - OK: Empresa Teste 1762957965735 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:126:21)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:132:17)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762957965204 e dados associados exclu√≠dos com sucesso.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:139:25)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762957965488 e dados associados exclu√≠dos com sucesso.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:139:25)

  console.log
    - ‚úÖ Empresa Empresa Teste 1762957965735 e dados associados exclu√≠dos com sucesso.

      at Object.<anonymous> (Testes/3-security/multi-tenant.test.js:139:25)


--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 PASS  Testes/3-security/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    ‚àö deve criar uma transa√ß√£o para cada empresa (156 ms)
    ‚àö deve impedir que uma empresa acesse a transa√ß√£o de outra (180 ms)
    ‚àö deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes (96 ms)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/2-features/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    √ó deve CRIAR uma nova transa√ß√£o com sucesso (26 ms)
    √ó deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos (17 ms)
    √ó deve LISTAR as transa√ß√µes do usu√°rio logado
    √ó deve OBTER uma transa√ß√£o espec√≠fica pelo ID (1 ms)
    √ó deve ATUALIZAR uma transa√ß√£o existente
    √ó deve EXCLUIR uma transa√ß√£o existente

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve CRIAR uma nova transa√ß√£o com sucesso

    AxiosError: Request failed with status code 401

      45 |         };
      46 |
    > 47 |         const response = await axios.post(`${API_URL}/transactions`, transactionData, {
         |                          ^
      48 |             headers: { Authorization: `Bearer ${userToken}` }
      49 |         });
      50 |

      at settle (node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (Testes/2-features/transactions.test.js:47:26)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve falhar ao tentar criar uma transa√ß√£o com dados inv√°lidos

    expect(received).toBe(expected) // Object.is equality

    Expected: 500
    Received: 401

      76 |             fail('A cria√ß√£o de transa√ß√£o com dados inv√°lidos deveria ter falhado.');
      77 |         } catch (error) {
    > 78 |             expect(error.response.status).toBe(500); // Mongoose validation error results in 500 in this setup
         |                                           ^
      79 |         }
      80 |     });
      81 |

      at Object.<anonymous> (Testes/2-features/transactions.test.js:78:43)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve LISTAR as transa√ß√µes do usu√°rio logado

    expect(received).toBeDefined()

    Received: undefined

      82 |     it('deve LISTAR as transa√ß√µes do usu√°rio logado', async () => {
      83 |         // Este teste depende que o anterior tenha criado uma transa√ß√£o
    > 84 |         expect(createdTransactionId).toBeDefined();
         |                                      ^
      85 |
      86 |         const response = await axios.get(`${API_URL}/transactions`, {
      87 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.<anonymous> (Testes/2-features/transactions.test.js:84:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve OBTER uma transa√ß√£o espec√≠fica pelo ID

    expect(received).toBeDefined()

    Received: undefined

       98 |
       99 |     it('deve OBTER uma transa√ß√£o espec√≠fica pelo ID', async () => {
    > 100 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      101 |
      102 |         const response = await axios.get(`${API_URL}/transactions/${createdTransactionId}`, {
      103 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.<anonymous> (Testes/2-features/transactions.test.js:100:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve ATUALIZAR uma transa√ß√£o existente

    expect(received).toBeDefined()

    Received: undefined

      110 |
      111 |     it('deve ATUALIZAR uma transa√ß√£o existente', async () => {
    > 112 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      113 |
      114 |         const updatedData = {
      115 |             description: 'Venda de consultoria (Valor Atualizado)',

      at Object.<anonymous> (Testes/2-features/transactions.test.js:112:38)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ deve EXCLUIR uma transa√ß√£o existente

    expect(received).toBeDefined()

    Received: undefined

      128 |
      129 |     it('deve EXCLUIR uma transa√ß√£o existente', async () => {
    > 130 |         expect(createdTransactionId).toBeDefined();
          |                                      ^
      131 |
      132 |         const response = await axios.delete(`${API_URL}/transactions/${createdTransactionId}`, {
      133 |             headers: { Authorization: `Bearer ${userToken}` }

      at Object.<anonymous> (Testes/2-features/transactions.test.js:130:38)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/4-reports/reports.test.js
  8. M√≥dulo de Relat√≥rios
    √ó deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF (24 ms)

  ‚óè 8. M√≥dulo de Relat√≥rios ‚Ä∫ deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF

    AxiosError: Request failed with status code 401

      27 |
      28 |   test('deve EXPORTAR um relat√≥rio de transa√ß√µes em formato PDF', async () => {
    > 29 |     const response = await axios.get(`${API_URL}/reports/export/transactions-pdf`, {
         |                      ^
      30 |       headers: { Authorization: `Bearer ${companyA.token}` },
      31 |       responseType: 'arraybuffer', // Importante para receber arquivos bin√°rios
      32 |     });

      at settle (node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (Testes/4-reports/reports.test.js:29:22)


--- üöÄ [ETAPA 1 de 4] Iniciando Ambiente de Teste (Jest Environment) ---
   - [PROCESSO] Lendo configura√ß√£o do banco de dados de teste...
   - [ATEN√á√ÉO] Usando banco de dados de DESENVOLVIMENTO para os testes. As cole√ß√µes ser√£o limpas.

--- üöÄ [ETAPA 2 de 4] Limpando e populando o banco de dados de TESTE ---
   - [OK] Dados de teste (empresas e usu√°rios) injetados no ambiente global.

--- üßπ [ENV] Desconectando do banco de dados ---
--- ‚úÖ [ENV] Ambiente de teste finalizado ---
 FAIL  Testes/2-features/clients.test.js
  ‚óè Test suite failed to run

    Your test suite must contain at least one test.

      at onResult (node_modules/@jest/core/build/index.js:1057:18)
      at node_modules/@jest/core/build/index.js:1127:165
      at node_modules/emittery/index.js:363:13
          at Array.map (<anonymous>)
      at Emittery.emit (node_modules/emittery/index.js:361:23)

Test Suites: 6 failed, 1 passed, 7 total
Tests:       16 failed, 3 passed, 19 total
Snapshots:   0 total
Time:        59.057 s
Ran all test suites.

--- FIM DOS TESTES AUTOMATIZADOS (Status: Falha) ---
