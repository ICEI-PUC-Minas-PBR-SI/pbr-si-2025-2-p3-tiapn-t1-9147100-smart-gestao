
--- üöÄ Iniciando Setup Global de Testes ---
‚úÖ Empresa Padr√£o 1 criada para os testes.
‚úÖ Empresa Padr√£o 2 criada para os testes.
--- ‚úÖ Setup Global Conclu√≠do. Dados salvos em Testes\test-setup.json ---

  console.log
    Debug transactions.test.js RF-004: createdTransactionId=690c97d72a2dac836459a0ae, userToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OTBjOTdkNjJhMmRhYzgzNjQ1OWEwOWEiLCJyb2xlIjoiNjhmMzExMmE2OWUzZjY1ZDI3NTA1ZDQ3IiwiY29tcGFueUlkIjoiNjkwYzk3ZDYyYTJkYWM4MzY0NTlhMDk4IiwiaWF0IjoxNzYyNDMyOTgyLCJleHAiOjE3NjI0MzM4ODJ9.xy6DpkVWntKzwPkSj6FjezEazfR2X6SIsw0O1w71mVQ

      at Object.log (transactions.test.js:63:17)

  console.log
    
    --- Configurando 5 empresas para o teste multi-tenant ---

      at Object.log (multi-tenant.test.js:12:17)

  console.log
    Debug: userId from login for Empresa Teste 1762432983502: 690c97d72a2dac836459a0c7

      at Object.log (multi-tenant.test.js:33:21)

  console.log
    ‚úÖ Empresa 1 (Empresa Teste 1762432983502) cadastrada e logada.

      at Object.log (multi-tenant.test.js:42:21)

  console.log
    Debug: userId from login for Empresa Teste 1762432983781: 690c97d72a2dac836459a0d3

      at Object.log (multi-tenant.test.js:33:21)

  console.log
    ‚úÖ Empresa 2 (Empresa Teste 1762432983781) cadastrada e logada.

      at Object.log (multi-tenant.test.js:42:21)

  console.log
    Debug: userId from login for Empresa Teste 1762432984042: 690c97d82a2dac836459a0df

      at Object.log (multi-tenant.test.js:33:21)

  console.log
    ‚úÖ Empresa 3 (Empresa Teste 1762432984042) cadastrada e logada.

      at Object.log (multi-tenant.test.js:42:21)

  console.log
    Debug: userId from login for Empresa Teste 1762432984308: 690c97d82a2dac836459a0eb

      at Object.log (multi-tenant.test.js:33:21)

  console.log
    ‚úÖ Empresa 4 (Empresa Teste 1762432984308) cadastrada e logada.

      at Object.log (multi-tenant.test.js:42:21)

  console.log
    Debug: userId from login for Empresa Teste 1762432984565: 690c97d82a2dac836459a0f7

      at Object.log (multi-tenant.test.js:33:21)

  console.log
    ‚úÖ Empresa 5 (Empresa Teste 1762432984565) cadastrada e logada.

      at Object.log (multi-tenant.test.js:42:21)

  console.log
    --- Configura√ß√£o multi-tenant conclu√≠da ---

      at Object.log (multi-tenant.test.js:44:17)

  console.log
    
    --- Criando transa√ß√µes individuais para cada empresa ---

      at Object.log (multi-tenant.test.js:49:17)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762432983502. ID: 690c97d82a2dac836459a0ff

      at Object.log (multi-tenant.test.js:70:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762432983781. ID: 690c97d82a2dac836459a106

      at Object.log (multi-tenant.test.js:70:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762432984042. ID: 690c97d92a2dac836459a10d

      at Object.log (multi-tenant.test.js:70:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762432984308. ID: 690c97d92a2dac836459a114

      at Object.log (multi-tenant.test.js:70:21)

  console.log
    Transa√ß√£o criada para Empresa Teste 1762432984565. ID: 690c97d92a2dac836459a11b

      at Object.log (multi-tenant.test.js:70:21)

  console.log
    
    --- Validando isolamento de dados entre todas as empresas ---

      at Object.log (multi-tenant.test.js:76:17)

  console.log
    
    Verificando a transa√ß√£o 690c97d82a2dac836459a0ff da Empresa Teste 1762432983502

      at Object.log (multi-tenant.test.js:83:21)

  console.log
    - OK: Empresa Teste 1762432983781 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984042 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984308 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984565 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    
    Verificando a transa√ß√£o 690c97d82a2dac836459a106 da Empresa Teste 1762432983781

      at Object.log (multi-tenant.test.js:83:21)

  console.log
    - OK: Empresa Teste 1762432983502 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984042 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984308 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984565 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    
    Verificando a transa√ß√£o 690c97d92a2dac836459a10d da Empresa Teste 1762432984042

      at Object.log (multi-tenant.test.js:83:21)

  console.log
    - OK: Empresa Teste 1762432983502 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432983781 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984308 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984565 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    
    Verificando a transa√ß√£o 690c97d92a2dac836459a114 da Empresa Teste 1762432984308

      at Object.log (multi-tenant.test.js:83:21)

  console.log
    - OK: Empresa Teste 1762432983502 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432983781 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984042 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984565 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    
    Verificando a transa√ß√£o 690c97d92a2dac836459a11b da Empresa Teste 1762432984565

      at Object.log (multi-tenant.test.js:83:21)

  console.log
    - OK: Empresa Teste 1762432983502 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432983781 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984042 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    - OK: Empresa Teste 1762432984308 foi bloqueada (Status 404).

      at Object.log (multi-tenant.test.js:101:29)

  console.log
    
    --- Validando listagem de transa√ß√µes ---

      at Object.log (multi-tenant.test.js:108:17)

  console.log
    - OK: Empresa Teste 1762432983502 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:120:21)

  console.log
    - OK: Empresa Teste 1762432983781 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:120:21)

  console.log
    - OK: Empresa Teste 1762432984042 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:120:21)

  console.log
    - OK: Empresa Teste 1762432984308 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:120:21)

  console.log
    - OK: Empresa Teste 1762432984565 listou apenas sua pr√≥pria transa√ß√£o.

      at Object.log (multi-tenant.test.js:120:21)

  console.log
    
    --- Limpando dados de teste (Teardown) ---

      at Object.log (multi-tenant.test.js:126:17)

  console.error
    - ‚ùå Falha ao excluir a empresa Empresa Teste 1762432983502: <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Cannot DELETE /api/auth/users/690c97d72a2dac836459a0c7</pre>
    </body>
    </html>
    

      134 |                         console.log(`- ‚úÖ Empresa ${company.companyName} exclu√≠da com sucesso.`);
      135 |                     }catch (error) {
    > 136 |                 console.error(`- ‚ùå Falha ao excluir a empresa ${company.companyName}:`, error.response?.data || error.message);
          |                         ^
      137 |             }
      138 |         }
      139 |     });

      at Object.error (multi-tenant.test.js:136:25)

  console.error
    - ‚ùå Falha ao excluir a empresa Empresa Teste 1762432983781: <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Cannot DELETE /api/auth/users/690c97d72a2dac836459a0d3</pre>
    </body>
    </html>
    

      134 |                         console.log(`- ‚úÖ Empresa ${company.companyName} exclu√≠da com sucesso.`);
      135 |                     }catch (error) {
    > 136 |                 console.error(`- ‚ùå Falha ao excluir a empresa ${company.companyName}:`, error.response?.data || error.message);
          |                         ^
      137 |             }
      138 |         }
      139 |     });

      at Object.error (multi-tenant.test.js:136:25)

  console.error
    - ‚ùå Falha ao excluir a empresa Empresa Teste 1762432984042: <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Cannot DELETE /api/auth/users/690c97d82a2dac836459a0df</pre>
    </body>
    </html>
    

      134 |                         console.log(`- ‚úÖ Empresa ${company.companyName} exclu√≠da com sucesso.`);
      135 |                     }catch (error) {
    > 136 |                 console.error(`- ‚ùå Falha ao excluir a empresa ${company.companyName}:`, error.response?.data || error.message);
          |                         ^
      137 |             }
      138 |         }
      139 |     });

      at Object.error (multi-tenant.test.js:136:25)

  console.error
    - ‚ùå Falha ao excluir a empresa Empresa Teste 1762432984308: <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Cannot DELETE /api/auth/users/690c97d82a2dac836459a0eb</pre>
    </body>
    </html>
    

      134 |                         console.log(`- ‚úÖ Empresa ${company.companyName} exclu√≠da com sucesso.`);
      135 |                     }catch (error) {
    > 136 |                 console.error(`- ‚ùå Falha ao excluir a empresa ${company.companyName}:`, error.response?.data || error.message);
          |                         ^
      137 |             }
      138 |         }
      139 |     });

      at Object.error (multi-tenant.test.js:136:25)

  console.error
    - ‚ùå Falha ao excluir a empresa Empresa Teste 1762432984565: <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Cannot DELETE /api/auth/users/690c97d82a2dac836459a0f7</pre>
    </body>
    </html>
    

      134 |                         console.log(`- ‚úÖ Empresa ${company.companyName} exclu√≠da com sucesso.`);
      135 |                     }catch (error) {
    > 136 |                 console.error(`- ‚ùå Falha ao excluir a empresa ${company.companyName}:`, error.response?.data || error.message);
          |                         ^
      137 |             }
      138 |         }
      139 |     });

      at Object.error (multi-tenant.test.js:136:25)

  console.log
    
    --- Criando transa√ß√£o para Empresa A ---

      at Object.log (isolamento.test.js:27:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Status): 201

      at Object.log (isolamento.test.js:40:17)

  console.log
    Empresa A - Criar Transa√ß√£o (Corpo): {
      "companyId": "690c97d62a2dac836459a098",
      "userId": "690c97d62a2dac836459a09a",
      "type": "expense",
      "description": "Transa√ß√£o de Teste Empresa A",
      "amount": 100,
      "date": "2025-11-06T12:43:05.621Z",
      "paymentMethod": "other",
      "status": "pending",
      "_id": "690c97d92a2dac836459a12c",
      "createdAt": "2025-11-06T12:43:05.649Z",
      "updatedAt": "2025-11-06T12:43:05.649Z",
      "__v": 0
    }

      at Object.log (isolamento.test.js:41:17)

  console.log
    Empresa A - ID da Transa√ß√£o Criada: 690c97d92a2dac836459a12c

      at Object.log (isolamento.test.js:45:17)

  console.log
    
    --- Tentando acessar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:48:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions/690c97d92a2dac836459a12c com token da Empresa B

      at Object.log (isolamento.test.js:49:17)

  console.log
    Empresa B - Acessar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:57:21)

  console.log
    Empresa B - Acessar Transa√ß√£o (Corpo): "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<title>Error</title>\n</head>\n<body>\n<pre>Cannot GET /api/transactions/690c97d92a2dac836459a12c</pre>\n</body>\n</html>\n"

      at Object.log (isolamento.test.js:58:21)

  console.log
    
    --- Tentando modificar transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:68:17)

  console.log
    Enviando: PUT para http://localhost:5000/api/transactions/690c97d92a2dac836459a12c com token da Empresa B

      at Object.log (isolamento.test.js:70:17)

  console.log
    Dados da atualiza√ß√£o: {
      "description": "Tentativa de Modifica√ß√£o pela Empresa B",
      "amount": 999
    }

      at Object.log (isolamento.test.js:71:17)

  console.log
    Empresa B - Modificar Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:79:21)

  console.log
    Empresa B - Modificar Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:80:21)

  console.log
    
    --- Tentando excluir transa√ß√£o da Empresa A com token da Empresa B ---

      at Object.log (isolamento.test.js:86:17)

  console.log
    Enviando: DELETE para http://localhost:5000/api/transactions/690c97d92a2dac836459a12c com token da Empresa B

      at Object.log (isolamento.test.js:87:17)

  console.log
    Empresa B - Excluir Transa√ß√£o (Status): 404

      at Object.log (isolamento.test.js:95:21)

  console.log
    Empresa B - Excluir Transa√ß√£o (Corpo): {
      "message": "Transaction n√£o encontrada"
    }

      at Object.log (isolamento.test.js:96:21)

  console.log
    
    --- Tentando listar transa√ß√µes com token da Empresa B ---

      at Object.log (isolamento.test.js:104:17)

  console.log
    Enviando: GET para http://localhost:5000/api/transactions com token da Empresa B

      at Object.log (isolamento.test.js:105:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Status): 200

      at Object.log (isolamento.test.js:113:17)

  console.log
    Empresa B - Listar Transa√ß√µes (Corpo): []

      at Object.log (isolamento.test.js:114:17)

  console.log
    
    --- Teste: Validar setup do usu√°rio ---

      at Object.log (api.test.js:28:17)

  console.log
    ‚úÖ Usu√°rio da Empresa A carregado do setup.

      at Object.log (api.test.js:31:17)

  console.log
    
    --- Teste: Barrar e-mail duplicado ---

      at Object.log (api.test.js:43:17)

  console.log
    ‚úÖ E-mail duplicado barrado com sucesso (Status 409).

      at Object.log (api.test.js:54:21)

  console.log
    
    --- Teste: Login com senha incorreta ---

      at Object.log (api.test.js:63:17)

  console.log
    ‚úÖ Login com senha incorreta falhou como esperado (Status 401).

      at Object.log (api.test.js:72:21)

  console.log
    
    --- Teste: Login com sucesso ---

      at Object.log (api.test.js:81:17)

  console.log
    ‚úÖ Login realizado com sucesso.

      at Object.log (api.test.js:90:17)

  console.log
    
    --- Teste: Acesso a rota protegida sem token ---

      at Object.log (api.test.js:94:17)

  console.log
    ‚úÖ Acesso sem token foi barrado como esperado (Status 401).

      at Object.log (api.test.js:104:21)

(node:21976) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 FAIL  Testes/transactions.test.js
  4. M√≥dulo de Transa√ß√µes (CRUD)
    ‚àö RF-002: deve CRIAR uma nova transa√ß√£o com sucesso (74 ms)
    ‚àö RF-003: deve LISTAR as transa√ß√µes do usu√°rio logado (41 ms)
    √ó RF-004: deve OBTER uma transa√ß√£o espec√≠fica pelo ID (29 ms)
    ‚àö RF-005: deve ATUALIZAR uma transa√ß√£o existente (71 ms)
    ‚àö RF-006: deve EXCLUIR uma transa√ß√£o existente (63 ms)

  ‚óè 4. M√≥dulo de Transa√ß√µes (CRUD) ‚Ä∫ RF-004: deve OBTER uma transa√ß√£o espec√≠fica pelo ID

    AxiosError: Request failed with status code 404

      62 |
      63 |         console.log(`Debug transactions.test.js RF-004: createdTransactionId=${createdTransactionId}, userToken=${userToken}`); // Debug log
    > 64 |         const response = await axios.get(`${API_URL}/transactions/${createdTransactionId}`, {
         |                          ^
      65 |             headers: { Authorization: `Bearer ${userToken}` }
      66 |         });
      67 |

      at settle (../node_modules/axios/lib/core/settle.js:19:12)
      at IncomingMessage.handleStreamEnd (../node_modules/axios/lib/adapters/http.js:793:11)
      at Axios.request (../node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (transactions.test.js:64:26)

 PASS  Testes/multi-tenant.test.js
  3. Teste de Isolamento de Dados em Larga Escala (Multi-Tenant)
    ‚àö deve criar uma transa√ß√£o para cada empresa (335 ms)
    ‚àö deve impedir que uma empresa acesse a transa√ß√£o de outra (73 ms)
    ‚àö deve garantir que cada empresa liste apenas suas pr√≥prias transa√ß√µes (196 ms)

 PASS  Testes/isolamento.test.js
  2. Teste de Isolamento de Dados (Transa√ß√µes)
    ‚àö deve impedir o acesso, modifica√ß√£o e exclus√£o de transa√ß√µes entre empresas (171 ms)
    ‚àö deve impedir que a Empresa B liste todas as transa√ß√µes da Empresa A (40 ms)

 PASS  Testes/api.test.js
  1. M√≥dulo de Autentica√ß√£o
    ‚àö RF-001: deve ter cadastrado a Empresa A com sucesso no setup global (3 ms)
    ‚àö deve barrar o cadastro de um usu√°rio com e-mail j√° existente (31 ms)
    ‚àö deve falhar o login com senha incorreta (116 ms)
    ‚àö deve realizar o login com sucesso para a Empresa A (87 ms)
    ‚àö deve proteger rotas, barrando acesso sem token (3 ms)

Test Suites: 1 failed, 3 passed, 4 total
Tests:       1 failed, 14 passed, 15 total
Snapshots:   0 total
Time:        3.587 s, estimated 4 s
Ran all test suites.
